<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









 


   
  
  


<html>
  <head>
    <script type="text/javascript" language="JavaScript">
    ORIGINAL_PAGE_PATH = "/apis/earth/articles/domtraversal.html";
    </script>
    
    
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>DOM Part II: Using the GEarthExtensions Utility Library for Easy DOM Manipulation - Google Earth API - Google Code</title>
<script type="text/javascript"><!--
(function(){function a(){this.t={};this.tick=function(c){this.t[c]=(new Date).getTime()};this.tick("start")}var b=new a;window.jstiming={Timer:a,load:b};if(window.external&&window.external.pageT)window.jstiming.pt=window.external.pageT;})();

var _tocPath_ = '/apis/earth/documentation/_toc.ezt';
var codesite_token = null;
var logged_in_user_email = null;
//--></script>
<link href="../../../css/codesite.pack.04102009.css" type="text/css" rel="stylesheet">
<script src="../../../js/codesite_head.pack.04102009.js" type="text/javascript"></script>
<script type="text/javascript">CODESITE_CSITimer['load'].tick('bhs');</script>
<link rel="search" type="application/opensearchdescription+xml" title="Google Code" href="http://code.google.com/osd.xml">

<!--[if IE]><link rel="stylesheet" type="text/css" href="../../../css/iehacks.css"><![endif]-->

  </head>

  <body class="gc-documentation">

    
    
    <div id="gb">
 <span>
  
    <a id="lang-dropdown" class="dropdown" href="http://code.google.com" onclick="return false;"><img width="13" height="13" class="globeicon" src="../../../images/globe2_small.png"
     ><span style="text-decoration:underline">English</span> <span style="font-size:.75em;">&#9660;</span></a>
  
 </span>
</div>

<div class="gbh" style="left:0px;"></div>
<div class="gbh" style="right:0px;"></div>

<div id="gc-container">
<a id="top"></a>
<div id="skipto">
  <a href="#gc-pagecontent">Skip to page content</a>
  <a href="#gc-toc">Skip to main navigation</a>
</div>

<div id="gc-header">
  <div id="logo"><a href="http://code.google.com">
  
  
     <img src="../../../images/code_logo.png" height="40" width="161" alt="Google Code" style="border:0;margin:3px 0 0 0;">
  
  
  </a></div>
  <div id="search">
    <div id="searchForm" class="searchForm">
      <form id="cse" action="http://www.google.com/cse" accept-charset="utf-8" class="gsc-search-box" onsubmit="executeGSearch(document.getElementById('gsearchInput').value); return false;">
      <noscript>
      <input type="hidden" name="cref" value="http://code.google.com/cse/googlecode-context.xml">
      </noscript>
      <div id="gsc-search-box">
        <input id="gsearchInput" type="text" name="q" maxlength="2048" class="gsc-input" autocomplete="off" title="Google Code Search" style="width:345px">
        <div id="cs-searchresults" onclick="event.cancelBubble = true;"></div>
        <input title="Search" id="gsearchButton" class="gsc-search-button" name="sa" value="Search" type="submit">
        <div class="greytext">e.g. "ajax apis" or "open source"</div>
      </div>
      </form>
    </div> <!-- end searchForm -->
  </div> <!-- end search -->



<h2 id="googlecode-promo">Make web development faster with these <a href="http://chrome.google.com/extensions/featured/web_dev" onclick="siteTracker._trackEvent('Promos','Web Development',this.href);">Chrome Extensions</a>!</h2>

</div> <!-- end gc-header -->


<div id="codesiteContent">

<a id="gc-topnav-anchor"></a>
<div id="gc-topnav">
  <h1 style="padding:0 0 0 6px;">Google Earth API</h1>
  <ul id="articles" class="gc-topnav-tabs">

    <li id="home_link">
      <a href="../index.html" title="Google Earth API home page">Home</a>
    </li>
  
    <li id="docs_link">
      <a href="../documentation/index.html" title="Official Google Earth API documentation">Docs</a>
    </li>
  
    <li id="faq_link">
      <a href="../faq.html" title="Answers to frequently asked questions about Google Earth API">FAQ</a>
    </li>
  
    <li id="articles_link">
      <a href="index.html" class="selected" title="Focused articles and tutorials for Google Earth API developers">Articles</a>
    </li>
  
    <li>
      <a href="http://googlegeodevelopers.blogspot.com/" title="Official Google Earth API blog">Blog</a>
    </li>
  
    <li>
      <a href="http://groups.google.com/group/google-earth-browser-plugin/topics" title="Google Earth API developer forum">Forum</a>
    </li>
  
    <li>
      <a href="http://code.google.com/apis/maps/terms.html" title="Google Earth API terms of service">Terms</a>
    </li>
  

  </ul>
</div> <!-- end gc-topnav -->

    <div class="g-section g-tpl-170">

      <a name="gc-toc"></a>
      <div class="g-unit g-first" id="gc-toc">
        <ul>
  <li><a href="http://code.google.com/apis/maps/signup.html">Sign up for a Maps API key</a></li>
</ul>

<div class="line"></div>

<ul>

  <li>
    <h2><a href="../documentation/reference/#">API Reference</a></h2>
    <div class="line"></div>
  </li>
  <li><h2>Developer's Guide</h2>
    <ul>
      <li><a href="../documentation/index.html">Introduction</a></li>
      <li><a href="../documentation/placemarks.html">Placemarks</a></li>
      <li><a href="../documentation/balloons.html">Balloons</a></li>
      <li><a href="../documentation/geometries.html">Geometries & Overlays</a></li>
      <li><a href="../documentation/camera_control.html">Camera Control</a></li>
      <li><a href="../documentation/layers.html">Layers & Controls</a></li>
      <li><a href="../documentation/time.html">Time</a> <sup class="new">Updated</sup></li>
      <li><a href="../documentation/ocean.html">Ocean</a></li>
      <li><a href="../documentation/sky_mars_moon.html">Sky, Mars, & Moon</a></li>
      <li><a href="../documentation/touring.html">Touring</a></li>
      <li><a href="../documentation/events.html">Events</a></li>
      <li><a href="../documentation/accessors.html">Accessors</a> <sup class="new">New!</sup></li>
      <li><a href="../documentation/containers.html">Object Containers</a></li>
      <li><a href="../documentation/kml.html">KML</a></li>
      <li><a href="../documentation/options.html">Options</a></li>
      <li><a href="../documentation/debugging.html">Debugging</a></li>
    </ul>
  </li>
        
  <div class="line"></div>
    
  <li><h2 class="tlw-expanded">Code Samples</h2>
    <ul>
      <li><a href="../documentation/examples.html">Examples</a></li>
      <li><a href="../documentation/demogallery.html">Demo Gallery</a>
      </li>
      <li><a href="http://code.google.com/apis/ajax/playground/?exp=earth">Code Playground</a></li>
    </ul>
  </li>
    
  <div class="line"></div>
    
  <li><h2 class="tlw-expanded">More Resources</h2>
    <ul>
      <li><a href="../documentation/mediagallery.html">Media</a></li>
      <li><a href="../documentation/releasenotes.html">Release Notes</a></li>
      <li><a href="http://code.google.com/p/earth-api-utility-library">Utility Library</a></li>
      <li><a href="http://code.google.com/p/earth-api-samples/issues/list?q=label%3AType-Defect">Known Issues</a></li>
    </ul>
  </li>
</ul>

<div class="line"></div>
<ul>
 <li>
    <h2>Related Docs</h2>
    <ul>                
      <li><a href="http://code.google.com/apis/kml/documentation/index.html">KML</a></li>
      <li><a href="http://code.google.com/apis/maps/documentation/index.html">Maps API</a></li>
    </ul>                
 </li>
</ul>
        <a class="hidden" href="#gc-topnav">More Google Earth API resource links</a>
      </div>

      <a name="gc-pagecontent"></a>
      <div class="g-unit" id="gc-pagecontent">
        <h1 class="page_title">DOM Part II: Using the GEarthExtensions Utility Library for Easy DOM Manipulation</h1>


<!-- ########## PAGE CONTENT ########## -->

<p>
  <em>Roman Nurik, Google Geo APIs Team</em><br/>
  <em>August 2009</em>
</p>

<h2>Contents</h2>
<div class="toc">
<ol>
<li><a href="#objective">Objective &amp; Prerequisites</a></li>
<li><a href="#traversal">Depth-first traversal, or 'walking the DOM' in the Earth API</a><ol>
  <li><a href="#traversal-utillib">Abstraction in the <code>GEarthExtensions</code> utility library</a></li>
  <li><a href="#traversal-sample">Sample usage</a></li>
</ol></li>
<li><a href="#commonpatterns">Common patterns and use cases</a><ol>
  <li><a href="#commonpatterns-findbyid">Finding an object by its ID</a></li>
  <li><a href="#commonpatterns-findbytype">Finding all objects of a given type</a></li>
  <li><a href="#commonpatterns-applystyleurl">Applying a <code>styleUrl</code> to every placemark in a document</a></li>
</ol></li>
<li><a href="#perf">Traversal performance</a></li>
<li><a href="#conclusion">Next steps and conclusion</a></li>
</ol>
</div>

<div id="objective">
<h1>Objective &amp; Prerequisites</h1>

<p>In <a href="domintro.html">Part I: An Introduction to the Earth API Document Object Model</a>,
I discuss the HTML and KML Document Object Models (DOMs) and their relation to
the Earth API. In this article, we'll learn about the <a
href="http://code.google.com/p/earth-api-utility-library/">GEarthExtensions</a>
utility library's method of simplifying DOM traversals and how we can easily
perform common DOM search and manipulation operations on entire KML document
trees using this method.</p>

<p>This article assumes you are familiar with JavaScript and know the basics of
the Earth API. It also assumes you have an understanding of the concepts discussed
in <a href="domintro.html">Part I</a>.</p>

</div>

<div id="traversal">
<h1>Depth-first traversal, or 'walking the DOM' in the Earth API</h1>

<p>Many common operations in the Earth API require running a computation over
(potentially) the entire KML DOM structure of either the plugin root object
(<a
href="../documentation/reference/interface_g_e_plugin.html">GEPlugin</a>)
or KML content loaded via <code>fetchKml</code> or <code>parseKml</code>.</p>

<p>Since KML is hierarchical and thus tree-like, it is possible to perform such
a computation using a <a href="http://en.wikipedia.org/wiki/Depth-first_search">
depth-first</a> tree traversal. To enact this traversal, we
can use a variety of Earth API DOM access methods discussed in previous sections
as well as in the <a href="../documentation/containers.html">object
containers</a> section of the Earth API documentation, such as
<code>GESchemaObjectContainer.getChildNodes</code> and the more specialized
<code>KmlPlacemark.getGeometry</code>.</p>

<p class="note"><strong>Note</strong>: For more information on loading KML
content in the Earth API, read <a href="earthapikml.html">An Overview of Using
KML in the Earth API</a>.</p>

</div>

<div id="traversal-utillib">
<h3>Abstraction in the <code>GEarthExtensions</code> utility library</h3>

<p>The <a
href="http://code.google.com/p/earth-api-utility-library/">GEarthExtensions</a>
Earth API utility library provides a variety of helper functions that developers
can use to simplify their application code. The
<code>gex.dom.walk</code> helper method in this library is
specifically designed to simplify DOM traversal in Earth API applications.</p>

<p>Before we dive into an example of what this simplified DOM traversal code
looks like, let's see all the complex code behind <code>gex.dom.walk</code> that
you don't need to worry about thanks to the utility library:</p>

<pre class="prettyprint lang-js">
/**
 * Performs a depth-first tree traversal on options.rootObject,
 * calling options.visitCallback on every KmlFeature and KmlGeometry in the
 * hierarchy. Minor elements such as &lt;name&gt; and &lt;coordinates&gt;, for
 * example, are not traversed.
 */
GEarthExtensions.prototype.dom.walk = function(options) {

  // Define code to be called for each node in the tree.
  var _visit = function(object) {
    // Visit the current node.
    var retValue = options.visitCallback.call(object);

    // Stop the traversal if the visit callback returns false.
    if (retValue === false)
      return false;

    // After visiting this node, see if it has children, and visit them.
    var objectContainer = null;
    if ('getFeatures' in object) {
      // This &lt;Document&gt; or &lt;Folder&gt; can have child features.
      objectContainer = object.getFeatures();
    } else if ('getGeometry' in object && object.getGeometry()) {
      // This feature has a geometry child.
      _visit(object.getGeometry());
    } else if ('getGeometries' in object) {
      // This &lt;MultiGeometry&gt; can have child geometries.
      objectContainer = object.getGeometries();
    } else if ('getOuterBoundary' in object) {
      // This &lt;Polygon&gt; can have outer and inner boundary geometries.
      if (object.getOuterBoundary())
        _visit(object.getOuterBoundary(), contextArgument.child);
      objectContainer = object.getInnerBoundaries();
    }

    // Iterate and visit the object's children if it is a container.
    if (objectContainer && objectContainer.hasChildNodes()) {
      var childNodes = objectContainer.getChildNodes();
      var numChildNodes = childNodes.getLength();

      for (var i = 0; i < numChildNodes; i++) {
        var child = childNodes.item(i);
        if (!_visit(child, contextArgument.child))
          return false;
      }
    }

    return true;
  };

  // Begin the traversal.
  _visit(options.rootObject);
};
</pre>

<p>The outer method performs a depth-first tree traversal on
<code>options.rootObject</code>, calling a nested, recursive function
<code>_visit</code> for each <code>KmlFeature</code> and
<code>KmlGeometry</code> under the root object's DOM hierarchy.
<code>_visit</code> in turn calls the user defined callback function
<code>options.visitCallback</code>, which contains the code for the desired DOM
operation.</p>
</div>

<div id="traversal-sample">
<h3>Sample usage</h3>

<p>As a developer using the utility library, however, the code you need to use
in your own application for a DOM traversal can be quite simple. For example,
the snippet below shows a basic DOM traversal that counts the number of line
strings in the plugin:</p>

<pre class="prettyprint lang-js">
// Instantiate the utility library.
var gex = new GEarthExtensions(ge);
var numLines = 0;

gex.dom.walk({
  rootObject: ge,
  visitCallback: function() {
    // 'this' is the current DOM node being visited.
    if ('getType' in this && this.getType() == 'KmlLineString')
      ++numLines;
  }
});

alert('There are ' + numLines + ' lines.');
</pre>

</div>

<div id="commonpatterns">
<h1>Common patterns and use cases</h1>

<p>Below are several commonly used operations that can be modeled as DOM
traversal problems and implemented using <code>gex.dom.walk</code>.</p>

</div>

<div id="commonpatterns-findbyid">
<h3>Finding an object by its ID</h3>

<p>One <a
href="http://code.google.com/p/earth-api-samples/issues/detail?id=60">oftenly
requested feature</a> is a function to retrieve an object by its KML ID, similar
to <code>document.getElementById</code> in JavaScript. Although this is already
available in the aforementioned utility library as
<code>gex.dom.getObjectById</code>, let's take a look at how to
implement this using only the <code>gex.dom.walk</code> function.</p>

<p>The below code assumes that the following global variables are already
  defined:</p>

<ul>
  <li><strong>gex</strong>: an instance of <code>GEarthExtensions</code></li>
  <li><strong>ge</strong>: an instance of <code>GEPlugin</code>, loaded via <code>google.earth.createInstance</code></li>
</ul>

<pre class="prettyprint lang-js">
/**
 * Returns the object in the DOM with the given ID, or null if
 * none was found.
 */
function getObjectById(id) {
  var foundObject = null;

  // Traverse the DOM, looking for the object with the given ID.
  gex.dom.walk({
    rootObject: ge,
    visitCallback: function() {
      if ('getId' in this && this.getId() == id) {
        foundObject = this;
        return false;  // Stop the walk.
      }
    }
  });

  return foundObject;
}
</pre>

</div>

<div id="commonpatterns-findbytype">
<h3>Finding all objects of a given type</h3>

<p>Another common use case for DOM traversal is to retrieve all objects of a
given object type (such as <code>KmlTour</code>). The below code shows how to
play the <em>n</em>th tour in a loaded KML file.</p>

<pre class="prettyprint lang-js">
/**
 * Plays the nth (0-based) tour in the file at the given KML URL; indexing
 * is depth-first.
 */
function playTour(kmlUrl, index) {
  google.earth.fetchKml(ge, kmlUrl, function(fetchedKmlObject) {
    if (!fetchedKmlObject)
      return;

    var tours = [];

    // Find all the tours.
    gex.dom.walk({
      rootObject: fetchedKmlObject,
      visitCallback: function() {
        if ('getType' in this && this.getType() == 'KmlTour')
          tours.push(this);
      }
    });

    // Play the nth tour
    if (index < tours.length) {
      ge.getTourPlayer().setTour(tours[index]);
      ge.getTourPlayer().play();
    }
  });
}
</pre>

</div>

<div id="commonpatterns-applystyleurl">
<h3>Applying a <code>styleUrl</code> to every placemark in a document</h3>

<p>Lastly, to change the <code>styleUrl</code> for each placemark
inside a given document or folder:</p>

<pre class="prettyprint lang-js">
/**
 * Sets the style URL of each placemark under the given root document or folder.
 */
function updateStyleUrls(container, styleUrl) {
  gex.dom.walk({
    rootObject: container,
    visitCallback: function() {
      if ('getType' in this && this.getType() == 'KmlPlacemark')
        this.setStyleUrl(styleUrl);
    }
  });
}
</pre>

</div>

<div id="perf">
<h1>Traversal performance</h1>

<p>A non-negligible cost is incurred the first time a node in the DOM tree is
visited because a JavaScript object corresponding to that node must be
initialized. <strong>Thus, in practice, DOM traversals over large KML files can
take a long time and large amounts of memory if care is not taken to limit the
scope of the search</strong>.</p>

<p>In the actual <code>gex.dom.walk</code> implementation (versus
the simplified version above), it is possible to selectively prevent descending
into a given node's subtree by setting a <code>walkChildren</code> flag to
<code>false</code> from within the visit callback.</p>

<p>For more details on <code>walkChildren</code> and precise documentation for
<code>gex.dom.walk</code>, see the relevant <a
href="http://code.google.com/p/earth-api-utility-library/wiki/GEarthExtensionsDomReference">GEarthExtensions
API reference</a>.</p>

</div>

<div id="conclusion">
<h1>Next steps</h1>

<p>This article discussed the <code>GEarthExtensions</code>
utility library for the Google Earth API, which has a <code>dom.walk</code>
method that simplifies common DOM traversal problems such as finding elements of
a given type or by ID.</p>

<p>To learn more about the utility library discussed in this article,
visit the <a
href="http://code.google.com/p/earth-api-utility-library/">GEarthExtensions
homepage</a>.</p>

</div>

<!-- ########## END PAGE CONTENT ########## -->


      </div><!-- end gc-pagecontent -->
   </div><!-- end gooey wrapper -->

    </div> <!-- end codesite content -->


<div id="gc-footer" dir="ltr">
  <div class="text">
    
    &copy;2010 Google -
    <a href="http://code.google.com">Code Home</a> -
    <a href="http://code.google.com/terms.html">Terms of Service</a> -
    <a href="http://code.google.com/privacy.html">Privacy Policy</a> -
    <a href="http://code.google.com/more">Site Directory</a>
    <br> <br>
    Google Code offered in:
    <a href="http://code.google.com/intl/en">English</a> -
    <a href="http://code.google.com/intl/es">Español</a> -
    <a href="http://code.google.com/intl/ja">日本語</a> -
    <a href="http://code.google.com/intl/ko">한국어</a> -
    <a href="http://code.google.com/intl/pt-BR">Português</a> -
    <a href="http://code.google.com/intl/ru">Pусский</a> -
    <a href="http://code.google.com/intl/zh-CN">中文(简体)</a> -
    <a href="http://code.google.com/intl/zh-TW">中文(繁體)</a>
  </div>
</div><!-- end gc-footer -->

</div><!-- end gc-container -->

<script type="text/javascript">CODESITE_CSITimer['load'].tick('ats');</script>
<script src="../../../js/codesite_tail.pack.04102009.js" type="text/javascript"></script>




<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(


    ['siteTracker._setAccount', 'UA-18071-1'],
    ['siteTracker._setDomainName', 'code.google.com'],
    ['siteTracker._setCookiePath', window.location.pathname.substring(0,
        window.location.pathname.lastIndexOf('/') + 1)],
    ['siteTracker._trackPageview']
);
(function() {
  var ga = document.createElement('script');

  ga.type = 'text/javascript';
  ga.async = true;
  ga.src = 'http://www.google-analytics.com/ga.js';
  (document.getElementsByTagName('head')[0] ||
   document.getElementsByTagName('body')[0]).appendChild(ga);
 })();
</script>




  </body>
</html>

