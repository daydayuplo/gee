<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">









 


   
  
  


<html>
  <head>
    <script type="text/javascript" language="JavaScript">
    ORIGINAL_PAGE_PATH = "/apis/earth/articles/phpsqlearth.html";
    </script>
    
    
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>A Database Driven Earth App: Using PHP & MySQL with the Earth API - Google Earth API - Google Code</title>
<script type="text/javascript"><!--
(function(){function a(){this.t={};this.tick=function(c){this.t[c]=(new Date).getTime()};this.tick("start")}var b=new a;window.jstiming={Timer:a,load:b};if(window.external&&window.external.pageT)window.jstiming.pt=window.external.pageT;})();

var _tocPath_ = '/apis/earth/documentation/_toc.ezt';
var codesite_token = null;
var logged_in_user_email = null;
//--></script>
<link href="../../../css/codesite.pack.04102009.css" type="text/css" rel="stylesheet">
<script src="../../../js/codesite_head.pack.04102009.js" type="text/javascript"></script>
<script type="text/javascript">CODESITE_CSITimer['load'].tick('bhs');</script>
<link rel="search" type="application/opensearchdescription+xml" title="Google Code" href="http://code.google.com/osd.xml">

<!--[if IE]><link rel="stylesheet" type="text/css" href="../../../css/iehacks.css"><![endif]-->

  </head>

  <body class="gc-documentation">

    
    
    <div id="gb">
 <span>
  
    <a id="lang-dropdown" class="dropdown" href="http://code.google.com" onclick="return false;"><img width="13" height="13" class="globeicon" src="../../../images/globe2_small.png"
     ><span style="text-decoration:underline">English</span> <span style="font-size:.75em;">&#9660;</span></a>
  
 </span>
</div>

<div class="gbh" style="left:0px;"></div>
<div class="gbh" style="right:0px;"></div>

<div id="gc-container">
<a id="top"></a>
<div id="skipto">
  <a href="#gc-pagecontent">Skip to page content</a>
  <a href="#gc-toc">Skip to main navigation</a>
</div>

<div id="gc-header">
  <div id="logo"><a href="http://code.google.com">
  
  
     <img src="../../../images/code_logo.png" height="40" width="161" alt="Google Code" style="border:0;margin:3px 0 0 0;">
  
  
  </a></div>
  <div id="search">
    <div id="searchForm" class="searchForm">
      <form id="cse" action="http://www.google.com/cse" accept-charset="utf-8" class="gsc-search-box" onsubmit="executeGSearch(document.getElementById('gsearchInput').value); return false;">
      <noscript>
      <input type="hidden" name="cref" value="http://code.google.com/cse/googlecode-context.xml">
      </noscript>
      <div id="gsc-search-box">
        <input id="gsearchInput" type="text" name="q" maxlength="2048" class="gsc-input" autocomplete="off" title="Google Code Search" style="width:345px">
        <div id="cs-searchresults" onclick="event.cancelBubble = true;"></div>
        <input title="Search" id="gsearchButton" class="gsc-search-button" name="sa" value="Search" type="submit">
        <div class="greytext">e.g. "ajax apis" or "open source"</div>
      </div>
      </form>
    </div> <!-- end searchForm -->
  </div> <!-- end search -->



<h2 id="googlecode-promo">Make web development faster with these <a href="http://chrome.google.com/extensions/featured/web_dev" onclick="siteTracker._trackEvent('Promos','Web Development',this.href);">Chrome Extensions</a>!</h2>

</div> <!-- end gc-header -->


<div id="codesiteContent">

<a id="gc-topnav-anchor"></a>
<div id="gc-topnav">
  <h1 style="padding:0 0 0 6px;">Google Earth API</h1>
  <ul id="articles" class="gc-topnav-tabs">

    <li id="home_link">
      <a href="../index.html" title="Google Earth API home page">Home</a>
    </li>
  
    <li id="docs_link">
      <a href="../documentation/index.html" title="Official Google Earth API documentation">Docs</a>
    </li>
  
    <li id="faq_link">
      <a href="../faq.html" title="Answers to frequently asked questions about Google Earth API">FAQ</a>
    </li>
  
    <li id="articles_link">
      <a href="index.html" class="selected" title="Focused articles and tutorials for Google Earth API developers">Articles</a>
    </li>
  
    <li>
      <a href="http://googlegeodevelopers.blogspot.com/" title="Official Google Earth API blog">Blog</a>
    </li>
  
    <li>
      <a href="http://groups.google.com/group/google-earth-browser-plugin/topics" title="Google Earth API developer forum">Forum</a>
    </li>
  
    <li>
      <a href="http://code.google.com/apis/maps/terms.html" title="Google Earth API terms of service">Terms</a>
    </li>
  

  </ul>
</div> <!-- end gc-topnav -->

    <div class="g-section g-tpl-170">

      <a name="gc-toc"></a>
      <div class="g-unit g-first" id="gc-toc">
        <ul>
  <li><a href="http://code.google.com/apis/maps/signup.html">Sign up for a Maps API key</a></li>
</ul>

<div class="line"></div>

<ul>

  <li>
    <h2><a href="../documentation/reference/#">API Reference</a></h2>
    <div class="line"></div>
  </li>
  <li><h2>Developer's Guide</h2>
    <ul>
      <li><a href="../documentation/index.html">Introduction</a></li>
      <li><a href="../documentation/placemarks.html">Placemarks</a></li>
      <li><a href="../documentation/balloons.html">Balloons</a></li>
      <li><a href="../documentation/geometries.html">Geometries & Overlays</a></li>
      <li><a href="../documentation/camera_control.html">Camera Control</a></li>
      <li><a href="../documentation/layers.html">Layers & Controls</a></li>
      <li><a href="../documentation/time.html">Time</a> <sup class="new">Updated</sup></li>
      <li><a href="../documentation/ocean.html">Ocean</a></li>
      <li><a href="../documentation/sky_mars_moon.html">Sky, Mars, & Moon</a></li>
      <li><a href="../documentation/touring.html">Touring</a></li>
      <li><a href="../documentation/events.html">Events</a></li>
      <li><a href="../documentation/accessors.html">Accessors</a> <sup class="new">New!</sup></li>
      <li><a href="../documentation/containers.html">Object Containers</a></li>
      <li><a href="../documentation/kml.html">KML</a></li>
      <li><a href="../documentation/options.html">Options</a></li>
      <li><a href="../documentation/debugging.html">Debugging</a></li>
    </ul>
  </li>
        
  <div class="line"></div>
    
  <li><h2 class="tlw-expanded">Code Samples</h2>
    <ul>
      <li><a href="../documentation/examples.html">Examples</a></li>
      <li><a href="../documentation/demogallery.html">Demo Gallery</a>
      </li>
      <li><a href="http://code.google.com/apis/ajax/playground/?exp=earth">Code Playground</a></li>
    </ul>
  </li>
    
  <div class="line"></div>
    
  <li><h2 class="tlw-expanded">More Resources</h2>
    <ul>
      <li><a href="../documentation/mediagallery.html">Media</a></li>
      <li><a href="../documentation/releasenotes.html">Release Notes</a></li>
      <li><a href="http://code.google.com/p/earth-api-utility-library">Utility Library</a></li>
      <li><a href="http://code.google.com/p/earth-api-samples/issues/list?q=label%3AType-Defect">Known Issues</a></li>
    </ul>
  </li>
</ul>

<div class="line"></div>
<ul>
 <li>
    <h2>Related Docs</h2>
    <ul>                
      <li><a href="http://code.google.com/apis/kml/documentation/index.html">KML</a></li>
      <li><a href="http://code.google.com/apis/maps/documentation/index.html">Maps API</a></li>
    </ul>                
 </li>
</ul>
        <a class="hidden" href="#gc-topnav">More Google Earth API resource links</a>
      </div>

      <a name="gc-pagecontent"></a>
      <div class="g-unit" id="gc-pagecontent">
        <h1 class="page_title">A Database Driven Earth App: Using PHP & MySQL with the Earth API</h1>


<!-- ########## PAGE CONTENT ########## -->
  
<div class=i>
<br/>
<em>Mano Marks, Google Geo APIs Team</em>
<br/>
<em>October 2009</em>

<br/>
<h2>Contents</h2>
<div class="toc">

<ol>
<li><a href="#objective">Objective</a></li>
<li><a href="#createtable">Creating the table</a></li>
<li><a href="#populatetable">Populating the table</a></li>
<li><a href="#outputxml">Outputting XML with PHP</a>
<ol>
<li><a href="#domxml">Option 1: Using PHP's domxml functions to output XML</a></li>
<li><a href="#echo">Option 2: Using PHP's echo to output XML</a></li>
<li><a href="#domfunctions">Option 3: Using PHP's DOM functions to output XML</a></li>
<li><a href="#output">Checking that XML output works</a></li>
</ol>
</li>
<li><a href="#createmap">Creating the map</a>
<ol>
<li><a href="#loadingxml">Loading the XML file</a></li>
<li><a href="#placemarks">Creating Placemarks &amp; Icons</a></li>
<li><a href="#puttingittogether">Putting it all together</a></li>
</ol></li>
<li><a href="#mapskml">Combining with Maps API or KML</a>
<ol>
<li><a href="#loadkml">Directly loading KML</a></li>
</ol></li>
<li><a href="#next">Next Steps</a></li>
</ol>
</div>
<a name="objective"></a><h1 class="objective">Objective</h1>
<p class="para">This tutorial is intended for developers who are familiar with
PHP/MySQL, and want to learn how to use the Google Earth API with a MySQL
database. After completing this tutorial, you will have a Google Earth page
based off a database of places. The map will differentiate between two
types of places&mdash;restaurants and bars&mdash;by giving their
placemarks distinguishing icons. A balloon with name and address
information will display above a marker when clicked.</p>

	<p class="para">This article is based on an earlier article for the Google Maps API by Pamela Fox and Lary Stucker. If you've created a Map using that <a href="http://code.google.com/apis/maps/articles/phpsqlajax.html" target="_blank">article</a>, or a similar article on <a href="http://code.google.com/apis/kml/articles/phpmysqlkml.html" target="_blank">Using PHP and MySQL to Create KML</a>, you can skip to <a href="#mapskml" target="_blank">Combining with Maps API or KML</a>. The first three sections are same across these articles. In fact, if you used the Maps article, you can add Earth by adding <a href="#mapskml">one line of code</a>.</p>
<br/>
<a name="createtable"></a><h1>Creating the table</h1>
<p class="para">When you create the MySQL table, to pay particular
attention to the <code>lat</code> and <code>lng</code> attributes.
With the current zoom capabilities of Google Earth, only
need 6 digits of precision after the decimal are required. To keep the storage
space required for our table at a minimum, specify that the
<code>lat</code> and <code>lng</code> attributes are floats of size
(10,6), allowing the fields to store 6 digits after the decimal, and up to 4 digits before the decimal (e.g. -123.456789).
Your table should also have an <code>id</code> attribute to serve as
the primary key, and a <code>type</code> attribute to distinguish
between restaurants and bars. </p>

<p class="para"><strong>Note:</strong> This tutorial uses location data that
already has the latitude and longitude information needed to plot
corresponding markers. If you're trying to use your own data that
doesn't yet have that information, use a batch geocoding service to
convert the addresses into latitudes/longitudes. Some sites make the
mistake of geocoding addresses each time a page loads, but doing so
will result in slower page loads and unnecessary repeat geocodes. It's
always better to hardcode the latitude/longitude information when
possible. This link contains a good list of geocoders: <a
href="http://groups.google.com/group/Google-Maps-API/web/resources-non-google-geocoders"
target="_blank">http://groups.google.com/group/Google-Maps-API/web/resources-non-google-geocoders</a>
</p>
<p class="para">If you prefer interacting with your database through the
phpMyAdmin interface, here's a screenshot of the table creation.
</p>
<p class="para">
<img src="http://www.google.com/help/hc/images/phpsqlgeocode_createtable.jpg" width="600" style="margin-left: 2em; border:1px solid grey"/>
</p>
<p class="para">If you don't have access to phpMyAdmin or prefer using SQL
commands instead, here's the SQL statement that creates the table (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_createtable.sql"
target="_blank">phpsqlajax_createtable.sql</a>):</p>

<pre class="prettyprint">
CREATE TABLE `markers` (
  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
  `name` VARCHAR( 60 ) NOT NULL ,
  `address` VARCHAR( 80 ) NOT NULL ,
  `lat` FLOAT( 10, 6 ) NOT NULL ,
  `lng` FLOAT( 10, 6 ) NOT NULL ,
  `type` VARCHAR( 30 ) NOT NULL
) ENGINE = MYISAM ;
</pre>
<br/>
<a name="populatetable"></a><h1>Populating the table</h1>
<p class="para">After creating the table, it's time to populate it with
data. Sample data for 10 Seattle places are provided below. In
phpMyAdmin, you can use the IMPORT tab to import various file
formats, including CSV (comma-separated values). Microsoft Excel and
Google Docs Spreadsheets both export to CSV format, so you can easily
transfer data from spreadsheets to MySQL tables by exporting 
then importing CSV files. </p>
<p class="para">Here's the sample data in CSV format (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_data.csv"
target="_blank">phpsqlajax_data.csv</a>):</p>
<pre class="prettyprint">
Pan Africa Market,"1521 1st Ave, Seattle, WA",47.608941,-122.340145,restaurant
Buddha Thai & Bar,"2222 2nd Ave, Seattle, WA",47.613591,-122.344394,bar
The Melting Pot,"14 Mercer St, Seattle, WA",47.624562,-122.356442,restaurant
Ipanema Grill,"1225 1st Ave, Seattle, WA",47.606366,-122.337656,restaurant
Sake House,"2230 1st Ave, Seattle, WA",47.612825,-122.34567,bar
Crab Pot,"1301 Alaskan Way, Seattle, WA",47.605961,-122.34036,restaurant
Mama's Mexican Kitchen,"2234 2nd Ave, Seattle, WA",47.613975,-122.345467,bar
Wingdome,"1416 E Olive Way, Seattle, WA",47.617215,-122.326584,bar
Piroshky Piroshky,"1908 Pike pl, Seattle, WA",47.610127,-122.342838,restaurant
</pre>

<p class="para">Here's a screenshot of the import options used to transform this
CSV into table data:</p>
<p class="para">
<img src="http://www.google.com/help/hc/images/phpsqlgeocode_importdata.jpg"
style="margin-left: 2em; border:1px solid grey" width="600px"/>
</p>
<p class="para">If you'd rather not use the phpMyAdmin interface, here are the SQL
statements that accomplish the same results ( <a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_data.sql"
target="_blank">phpsqlajax_data.sql</a>): </p>
<pre class="prettyprint">
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Pan Africa Market', '1521 1st Ave, Seattle, WA', '47.608941', '-122.340145', 'restaurant');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Buddha Thai & Bar', '2222 2nd Ave, Seattle, WA', '47.613591', '-122.344394', 'bar');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('The Melting Pot', '14 Mercer St, Seattle, WA', '47.624562', '-122.356442', 'restaurant');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Ipanema Grill', '1225 1st Ave, Seattle, WA', '47.606366', '-122.337656', 'restaurant');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Sake House', '2230 1st Ave, Seattle, WA', '47.612825', '-122.34567', 'bar');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Crab Pot', '1301 Alaskan Way, Seattle, WA', '47.605961', '-122.34036', 'restaurant');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Mama\'s Mexican Kitchen', '2234 2nd Ave, Seattle, WA', '47.613975', '-122.345467', 'bar');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Wingdome', '1416 E Olive Way, Seattle, WA', '47.617215', '-122.326584', 'bar');
INSERT INTO `markers` (`name`, `address`, `lat`, `lng`, `type`) VALUES ('Piroshky Piroshky', '1908 Pike pl, Seattle, WA', '47.610127', '-122.342838', 'restaurant');
</pre>
<br/>
<a name="outputxml"></a><h1>Outputting XML with PHP</h1>
<p class="para">At this point, you should have a table named <code>markers</code>

filled with sample data. You now need to write some PHP statements to
export the table data into an XML format that our map can retrieve
through asynchronous JavaScript calls. If you've never written PHP to
connect to a MySQL database, you should visit <a
href="http://www.php.net" target="_blank">php.net</a> and read up
 on <code>mysql_connect</code>, <code>mysql_select_db</code>, <code>my_sql_query</code>, and <code>mysql_error</code>.
</p>
<p class="para"><strong>Note:</strong> Some tutorials may suggest actually writing
your map page as a PHP file and outputting JavaScript for each marker
you want to create, but that technique can be problematic. By using
an XML file as an intermediary between our database and our Google
Map, it makes for a faster initial page load, a more flexible map
application, and easier debugging. You can independently verify the
XML output from the database and the JavaScript parsing of the
XML. And at any point, you could even decide to eliminate your
database entirely and just run the map based on static XML files.

</p>
<p class="para">First, you should put your database connection information in a
separate file. This is generally a good idea whenever you're using PHP
to access a database, as it keeps your confidential information in a
file that you won't be tempted to share. In the developer forums, we've
occasionally had people accidentally publish their database connection
information when they were just trying to debug their XML-outputting
code. The file should look like this, but with your own database
information filled in (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_dbinfo.php"
target="_blank">phpsqlajax_dbinfo.php</a>): </p>
<pre class="prettyprint">
&lt;?
$username="username";
$password="password";
$database="username-databaseName";
$server="server";
?&gt;
</pre>
<a name="domxml"></a><h3>Option 1: Using PHP's domxml functions to output XML</h3>
<p class="para">Check your configuration or try initializing a
<code>domxml_new_doc()</code> to determine if your server's PHP has

<code>dom_xml</code> functionality on. If you do have access to
<code>dom_xml</code> functions, you can use them to create XML nodes,
append child nodes, and output an XML document to the screen. The
<code>dom_xml</code> functions take care of subtleties such as
escaping special entities in the XML, and make it easy to create XML
with more complex structures. </p>
<p class="para">In the PHP, first initialize a new XML document and create the
<code>markers</code> parent node. Then connect to the database, execute a
<code>SELECT *</code> (select all) query on the <code>markers</code> table,
 and iterate through the results. For each row in the table (each location), create a new XML node with the
row attributes as XML attributes, and append it to the parent node. Then dump the XML to the screen.
</p>
<p class="para">

<strong>Note: </strong> If your database contains international characters or you otherwise need to force UTF-8 output, you can use <code><a href="http://us2.php.net/manual/en/function.utf8-encode.php">utf8_encode</a></code> on the outputted data.
</p>
<p class="para">The PHP file that does all that is shown below (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_genxml.php"
target="_blank">phpsqlajax_genxml.php</a>): </p>
<pre class="prettyprint">
&lt;?php
require("phpsqlajax_dbinfo.php");

// Start XML file, create parent node
$doc = domxml_new_doc("1.0");
$node = $doc-&gt;create_element("markers");
$parnode = $doc-&gt;append_child($node);

// Opens a connection to a MySQL server
$connection=mysql_connect ($server, $username, $password);
if (!$connection) {
  die('Not connected : ' . mysql_error());
}

// Set the active MySQL database
$db_selected = mysql_select_db($database, $connection);
if (!$db_selected) {
  die ('Can\'t use db : ' . mysql_error());
}

// Select all the rows in the markers table
$query = "SELECT * FROM markers WHERE 1";
$result = mysql_query($query);
if (!$result) {
  die('Invalid query: ' . mysql_error());
}

header("Content-type: text/xml");

// Iterate through the rows, adding XML nodes for each
while ($row = @mysql_fetch_assoc($result)){
  // ADD TO XML DOCUMENT NODE
  $node = $doc-&gt;create_element("marker");
  $newnode = $parnode-&gt;append_child($node);

  $newnode-&gt;set_attribute("name", $row['name']);
  $newnode-&gt;set_attribute("address", $row['address']);
  $newnode-&gt;set_attribute("lat", $row['lat']);
  $newnode-&gt;set_attribute("lng", $row['lng']);
  $newnode-&gt;set_attribute("type", $row['type']);
}

$xmlfile = $doc-&gt;dump_mem();
echo $xmlfile;

?&gt;

</pre>
<a name="echo"></a><h3>Option 2: Using PHP's echo to output XML</h3>
<p class="para">If you don't have access to PHP's <code>dom_xml</code> functions,
then you can simply output the XML with the <code>echo</code>
function. When using just the <code>echo</code> function, you'll need
to use a helper function (e.g. <code>parseToXML</code>)
 that will correctly encode a few special entities (&lt;,&gt;,",') to be XML-friendly.

</p>
<p class="para">In the PHP, first connect to the database and execute the
<code>SELECT *</code> (select all) query on the markers table. Then
echo out the parent <code>markers</code> node, and iterate through the
query results. For each row in the table (each location), you need to
echo out the XML node for that marker, sending the name and address
fields through the <code>parseToXML</code> function first in case
there are any special entities in them. Finish the script by echoing
out the closing <code>markers</code> tag. </p>
<p class="para">

<strong>Note: </strong> If your database contains international characters or you otherwise need to force UTF-8 output, you can use <code><a href="http://us2.php.net/manual/en/function.utf8-encode.php">utf8_encode</a></code> on the outputted data.
</p>
<p class="para">The PHP file that does all this is shown below (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_genxml2.php"
target="_blank">phpsqlajax_genxml2.php</a>): </p>
<pre class="prettyprint">
&lt;?php
require("phpsqlajax_dbinfo.php");

function parseToXML($htmlStr) 
{ 
$xmlStr=str_replace('<','&amp;lt;',$htmlStr); 
$xmlStr=str_replace('>','&amp;gt;',$xmlStr); 
$xmlStr=str_replace('"','&amp;quot;',$xmlStr); 
$xmlStr=str_replace("'",'&amp;#39;',$xmlStr); 
$xmlStr=str_replace("&",'&amp;amp;',$xmlStr); 
return $xmlStr; 
} 

// Opens a connection to a MySQL server
$connection=mysql_connect ($server, $username, $password);
if (!$connection) {
  die('Not connected : ' . mysql_error());
}

// Set the active MySQL database
$db_selected = mysql_select_db($database, $connection);
if (!$db_selected) {
  die ('Can\'t use db : ' . mysql_error());
}

// Select all the rows in the markers table
$query = "SELECT * FROM markers WHERE 1";
$result = mysql_query($query);
if (!$result) {
  die('Invalid query: ' . mysql_error());
}

header("Content-type: text/xml");

// Start XML file, echo parent node
echo '&lt;markers&gt;';

// Iterate through the rows, printing XML nodes for each
while ($row = @mysql_fetch_assoc($result)){
  // ADD TO XML DOCUMENT NODE
  echo '&lt;marker ';
  echo 'name="' . parseToXML($row['name']) . '" ';
  echo 'address="' . parseToXML($row['address']) . '" ';
  echo 'lat="' . $row['lat'] . '" ';
  echo 'lng="' . $row['lng'] . '" ';
  echo 'type="' . $row['type'] . '" ';
  echo '/&gt;';
}

// End XML file
echo '&lt;/markers&gt;';

?&gt;

</pre>
<a name="domfunctions"></a><h3>Option 3: Using PHP's DOM functions to output XML</h3>
<p class="para">
First, check your configuration and make sure you are using PHP5. If you aren't, then use one of the previous techniques.
</p>
<p class="para">
In PHP, first initialize a new XML document and create the <code>markers</code> parent node. Then connect to the database, execute a <code>SELECT *</code> (select all) query on the markers table, and iterate through the results. For each row in the table (each location), create a new XML node with the row attributes as XML attributes, and append it to the parent node. Then dump the XML to the screen.
</p>
<p class="para">
<strong>Note: </strong> If your database contains international characters or you otherwise need to force UTF-8 output, you can use <code><a href="http://us2.php.net/manual/en/function.utf8-encode.php">utf8_encode</a></code> on the outputted data.

</p>
<p class="para">The PHP file that does all this is shown below (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_genxml3.php"
target="_blank">phpsqlajax_genxml3.php</a>): </p>
<pre class="prettyprint">
&lt;?php  

require("phpsqlajax_dbinfo.php"); 

// Start XML file, create parent node

$dom = new DOMDocument("1.0");
$node = $dom->createElement("markers");
$parnode = $dom->appendChild($node); 

// Opens a connection to a MySQL server

$connection=mysql_connect ($server, $username, $password);
if (!$connection) {  die('Not connected : ' . mysql_error());} 

// Set the active MySQL database

$db_selected = mysql_select_db($database, $connection);
if (!$db_selected) {
  die ('Can\'t use db : ' . mysql_error());
} 

// Select all the rows in the markers table

$query = "SELECT * FROM markers WHERE 1";
$result = mysql_query($query);
if (!$result) {  
  die('Invalid query: ' . mysql_error());
} 

header("Content-type: text/xml"); 

// Iterate through the rows, adding XML nodes for each

while ($row = @mysql_fetch_assoc($result)){  
  // ADD TO XML DOCUMENT NODE  
  $node = $dom->createElement("marker");  
  $newnode = $parnode->appendChild($node);   
  $newnode->setAttribute("name",$row['name']);
  $newnode->setAttribute("address", $row['address']);  
  $newnode->setAttribute("lat", $row['lat']);  
  $newnode->setAttribute("lng", $row['lng']);  
  $newnode->setAttribute("type", $row['type']);
} 

echo $dom->saveXML();

?&gt;
</pre>
<a name="output"></a><h3>Checking that XML output works</h3>
<p class="para">Call the PHP script you created above from the browser to make sure it's producing
valid XML. If you suspect there's a problem with connecting to your
database, you may find it easier to debug if you remove the line in
the file that sets the header to the <code>text/xml</code> content
type, as that usually causes your browser to try to parse XML and may
make it difficult to see your debugging messages. </p>
<p class="para">

If the script is working correctly, you will see XML output like this (<a href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_expectedoutput.xml" target="_blank">phpsqlajax_expectedoutput.xml</a>):
</p>
<pre class="prettyprint">
&lt;markers&gt;
&lt;marker name="Pan Africa Market" address="1521 1st Ave, Seattle, WA" lat="47.608940" lng="-122.340141" type="restaurant"/&gt;
&lt;marker name="Buddha Thai & Bar" address="2222 2nd Ave, Seattle, WA" lat="47.613590" lng="-122.344391" type="bar"/&gt;
&lt;marker name="The Melting Pot" address="14 Mercer St, Seattle, WA" lat="47.624561" lng="-122.356445" type="restaurant"/&gt;
&lt;marker name="Ipanema Grill" address="1225 1st Ave, Seattle, WA" lat="47.606365" lng="-122.337654" type="restaurant"/&gt;
&lt;marker name="Sake House" address="2230 1st Ave, Seattle, WA" lat="47.612823" lng="-122.345673" type="bar"/&gt;

&lt;marker name="Crab Pot" address="1301 Alaskan Way, Seattle, WA" lat="47.605961" lng="-122.340363" type="restaurant"/&gt;
&lt;marker name="Mama's Mexican Kitchen" address="2234 2nd Ave, Seattle, WA" lat="47.613976" lng="-122.345467" type="bar"/&gt;
&lt;marker name="Wingdome" address="1416 E Olive Way, Seattle, WA" lat="47.617214" lng="-122.326584" type="bar"/&gt;
&lt;marker name="Piroshky Piroshky" address="1908 Pike pl, Seattle, WA" lat="47.610126" lng="-122.342834" type="restaurant"/&gt;
&lt;/markers&gt;
</pre>
<br/>

<a name="createmap"></a><h1>Creating the map</h1>
<p class="para">Once the XML is working in the browser, it's time to move on to
actually creating your placemarks with JavaScript. If you have never used the Earth API, please try some of the basic examples in the documentation
to make sure you understand the basics of developing with the Earth API. </p>
<a name="loadingxml"></a><h3>Loading the XML file</h3>
<p class="para">To load the XML file into our page, you can take advantage of the
Maps API function <code>GDownloadUrl</code>. This will require loading the Maps API as well. 

<code>GDownloadURL</code> is
a wrapper for the <code>XMLHttpRequest</code> that's used to request
an XML file from the server where the HTML page resides. The first
parameter to <code>GDownloadURL</code> is the path to your
file&mdash;it's usually easiest to have the XML file in the same
directory as the HTML so that you can just refer to it by filename.
The second parameter to <code>GDownloadURL</code> is the function
that's called when the XML is returned to the JavaScript. </p>

<p class="para"><strong>Note:</strong> It's important to know that
<code>GDownloadURL</code> is asynchronous&mdash;the callback function
won't be called as soon as you invoke <code>GDownloadURL</code>. The
bigger your XML file, the longer it may take. Don't put any code after
<code>GDownloadURL</code> that relies on the placemarks existing
already&mdash;put it inside the callback function instead. </p>
<p class="para">In the callback function, you need to find all the "marker"
elements in the XML, and iterate through them. For each marker element
you find, retrieve the name, address, type, and lat/lng attributes
and pass them to <code>createPlaceMark</code>, which returns a placemark
that you can add to Earth.</p>

<pre class="prettyprint">
GDownloadUrl("phpsqlajax_genxml3.php", function(data) {
  var xml = GXml.parse(data);
  var markers = xml.documentElement.getElementsByTagName("marker");
  for (var i = 0; i < markers.length; i++) {
    var name = markers[i].getAttribute("name");
    var address = markers[i].getAttribute("address");
    var type = markers[i].getAttribute("type");
    var lat = markers[i].getAttribute("lat");
    var lng = markers[i].getAttribute("lng");
    createPlacemark(name,address,type,lat,lng);
    
  }
});
</pre>

<a name="placemarks"></a><h3>Creating Placemarks &amp; Icons</h3>

<p class="para">Place all your placemark creation code in a <code>createPlacemark</code> 
function. 
This will create a point placemark, with a simple description and an icon based on the <code>type</code> variable. When the placemark is clicked, its name and description will pop up as a balloon. 
</p>
<pre class="prettyprint">
</p>
</p>
</p>
  function createPlacemark(name,address,type,lat,lng){
    var placemark = ge.createPlacemark('');
    placemark.setName(name);
    placemark.setDescription(address);
    var point = ge.createPoint('');
    point.setLatitude(parseFloat(lat));
    point.setLongitude(parseFloat(lng));
    placemark.setGeometry(point);
    placemark.setStyleSelector(createIcon(type));
    ge.getFeatures().appendChild(placemark);
    var icon = ge.createIcon('');
    if(type=="bar"){
      icon.setHref('http://maps.google.com/mapfiles/kml/pal2/icon27.png');
    } else{
      icon.setHref('http://maps.google.com/mapfiles/kml/pal2/icon63.png');
    }
    var style = ge.createStyle('');
    style.getIconStyle().setIcon(icon);
  }
}
  </pre>
<a name="puttingittogether"></a><h3>Putting it all together</h3>
<p class="para">Here's the web page that ties the markers, icons, and XML together.
When the page loads, the <code>init</code> function is called. This
function sets up Earth and then calls <code>initCallback</code> which calls <code>GDownloadUrl</code>.</p>

<p class="para">The full HTML that accomplishes this is shown below (<a
href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlajax/phpsqlajax_map.htm"
target="_blank">phpsqlajax_map.htm</a>):</p>
<pre class="prettyprint">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
  &lt;head&gt;
    &lt;meta http-equiv="content-type" content="text/html; charset=utf-8"/&gt;
    &lt;title&gt;Google Earth API + mySQL/PHP Example&lt;/title&gt;
    &lt;script src="http://www.google.com/jsapi?key=<i>ADDYourOwnKeyHere</i>"&gt; &lt;/script&gt; 
    &lt;script&gt; 
var ge;

google.load("earth", "1");
google.load("maps", "2");
function init() {
  google.earth.createInstance('map3d', initCallback, failureCallback);
}

function initCallback(instance){
  ge = instance;
  ge.getWindow().setVisibility(true);
  var la = ge.createLookAt('');
  la.set(47.616319, -122.349992, 25, ge.ALTITUDE_RELATIVE_TO_GROUND,
         -10, 60, 4000);
  ge.getView().setAbstractView(la);
  ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
  ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);  
  ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS, true);
  GDownloadUrl("phpsqlajax_genxml3.php", function(data) {
  var xml = GXml.parse(data);
  var markers = xml.documentElement.getElementsByTagName("marker");
  for (var i = 0; i &lt; markers.length; i++) {
    var name = markers[i].getAttribute("name");
    var address = markers[i].getAttribute("address");
    var type = markers[i].getAttribute("type");
    var lat = markers[i].getAttribute("lat");
    var lng = markers[i].getAttribute("lng");
    createPlacemark(name,address,type,lat,lng);  
    }
  });
}

function failureCallback(errorCode) {
}

function createPlacemark(name,address,type,lat,lng){
  var placemark = ge.createPlacemark('');
  placemark.setName(name);
  var point = ge.createPoint('');
  point.setLatitude(parseFloat(lat));
  point.setLongitude(parseFloat(lng));
  placemark.setGeometry(point);
  placemark.setStyleSelector(createIcon(type));
  ge.getFeatures().appendChild(placemark);
  placemark.setDescription(address);
  if(type=="bar"){
    icon.setHref('http://maps.google.com/mapfiles/kml/pal2/icon27.png');
  } else{
    icon.setHref('http://maps.google.com/mapfiles/kml/pal2/icon63.png');
  }
  var style = ge.createStyle('');
  style.getIconStyle().setIcon(icon);
}
&lt;/script&gt;
  &lt;/head&gt;

  &lt;body onload="init()"&gt;
    &lt;div id="map3d" style="width: 500px; height: 500px"&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;

</pre>

<p class="para">Your page should look like this when it's done:</p>
<p class="para">
<img src="../images/phpmysqlearth.jpg">
</p>
<a name="mapskml"></a><h1>Combining with Maps API or KML</h1>
<p class="para">On the other hand, if you used the article <a href="http://code.google.com/apis/maps/articles/phpsqlajax.html" target="_blank">Using PHP/MySQL with Google Maps</a>
 to create your database and a Google Map, you can add one line of code to your web page to add in the Earth API:</p>
<pre>map.addMapType(G_SATELLITE_3D_MAP);</pre>
<p class="para">That will put an Earth map type on your map, and when you click on it, your markers will show up in Earth</p>
<a name="loadkml"></a><h3>Directly loading KML</h3>
<p class="para">If you used <a href="http://code.google.com/apis/kml/articles/phpmysqlkml.html" target="_blank">Using PHP and MySQL to create KML</a>, then you can easily create a map that loads in the KML:</p>
<pre class="prettyprint">var ge;

google.load("earth", "1");

function init() {
  google.earth.createInstance('map3d', initCallback, failureCallback);
}

function initCallback(instance) {
  ge = instance;
  ge.getWindow().setVisibility(true);
  ge.getNavigationControl().setVisibility(ge.VISIBILITY_AUTO);
  ge.getLayerRoot().enableLayerById(ge.LAYER_BORDERS, true);
  ge.getLayerRoot().enableLayerById(ge.LAYER_ROADS, true);

  function finished(object) {
    if (!object) {
      setTimeout(function() {
        alert('Bad or null KML.');
      }, 0);
      return;
    }
    ge.getFeatures().appendChild(object);
    var la = ge.createLookAt('');
    la.set(37.77976, -122.418307, 25, ge.ALTITUDE_RELATIVE_TO_GROUND,
           180, 60, 500);
    ge.getView().setAbstractView(la);
  }

  var url = 'http://example.com/phpmysql_kmlnl.kml';
  google.earth.fetchKml(ge, url, finished);
}

function failureCallback(errorCode) {
}
</code></pre>
<p class="para">That would look something like this:</p>
<img src="../images/phpmysqlkmlearth.jpg"/>
<br/>
<a name="next"></a><h1>Next Steps</h1>
<p class="para">There's a lot more you can do with the data from the database. For instance, you can:
</p>
<ul><li>Sprouse up the balloon with an <a href="http://code.google.com/apis/earth/documentation/balloons.html#string_balloons" target="_blank">HTML string balloon</a></li>
<li>Allow users to submit data in a <a href="http://code.google.com/apis/maps/articles/phpsqlinfo.html" target="_blank">balloon</a></li>
<li>Add photos to the database for each location</li>
<li>Create an administration interface that lets you add more data</li>
</ul>
<p class="para">And much more. The more data you have, the more you can do with it.</p>
</div>

<!-- ########## END PAGE CONTENT ########## -->


      </div><!-- end gc-pagecontent -->
   </div><!-- end gooey wrapper -->

    </div> <!-- end codesite content -->


<div id="gc-footer" dir="ltr">
  <div class="text">
    
    &copy;2010 Google -
    <a href="http://code.google.com">Code Home</a> -
    <a href="http://code.google.com/terms.html">Terms of Service</a> -
    <a href="http://code.google.com/privacy.html">Privacy Policy</a> -
    <a href="http://code.google.com/more">Site Directory</a>
    <br> <br>
    Google Code offered in:
    <a href="http://code.google.com/intl/en">English</a> -
    <a href="http://code.google.com/intl/es">Español</a> -
    <a href="http://code.google.com/intl/ja">日本語</a> -
    <a href="http://code.google.com/intl/ko">한국어</a> -
    <a href="http://code.google.com/intl/pt-BR">Português</a> -
    <a href="http://code.google.com/intl/ru">Pусский</a> -
    <a href="http://code.google.com/intl/zh-CN">中文(简体)</a> -
    <a href="http://code.google.com/intl/zh-TW">中文(繁體)</a>
  </div>
</div><!-- end gc-footer -->

</div><!-- end gc-container -->

<script type="text/javascript">CODESITE_CSITimer['load'].tick('ats');</script>
<script src="../../../js/codesite_tail.pack.04102009.js" type="text/javascript"></script>




<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(


    ['siteTracker._setAccount', 'UA-18071-1'],
    ['siteTracker._setDomainName', 'code.google.com'],
    ['siteTracker._setCookiePath', window.location.pathname.substring(0,
        window.location.pathname.lastIndexOf('/') + 1)],
    ['siteTracker._trackPageview']
);
(function() {
  var ga = document.createElement('script');

  ga.type = 'text/javascript';
  ga.async = true;
  ga.src = 'http://www.google-analytics.com/ga.js';
  (document.getElementsByTagName('head')[0] ||
   document.getElementsByTagName('body')[0]).appendChild(ga);
 })();
</script>




  </body>
</html>

