<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">







 
 


 

  
  
  


<html>
  <head>
    <script type="text/javascript" language="JavaScript">
    ORIGINAL_PAGE_PATH = "/apis/maps/articles/geospatial.html";
    </script>
    
    
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>Geospatial Queries with Google App Engine using GeoModel - Google Maps API Family - Google Code</title>
<script type="text/javascript"><!--
(function(){function a(){this.t={};this.tick=function(c){this.t[c]=(new Date).getTime()};this.tick("start")}var b=new a;window.jstiming={Timer:a,load:b};if(window.external&&window.external.pageT)window.jstiming.pt=window.external.pageT;})();

var _tocPath_ = '/apis/maps/_toc.ezt';
var codesite_token = null;
var logged_in_user_email = null;
//--></script>
<link href="../../../css/codesite.pack.04102009.css" type="text/css" rel="stylesheet">
<script src="../../../js/codesite_head.pack.04102009.js" type="text/javascript"></script>
<script type="text/javascript">CODESITE_CSITimer['load'].tick('bhs');</script>
<link rel="search" type="application/opensearchdescription+xml" title="Google Code" href="http://code.google.com/osd.xml">

<!--[if IE]><link rel="stylesheet" type="text/css" href="../../../css/iehacks.css"><![endif]-->

    <link href="../../../css/semantic_headers.css" rel="stylesheet" type="text/css" />
  </head>

  <body class="gc-documentation">

    
    
    <div id="gb">
 <span>
  
    <a id="lang-dropdown" href="http://code.google.com" onclick="return false;"><span style="text-decoration:underline">English</span> <span style="font-size:.75em;">&#9660;</span></a>
  
 </span>
</div>

<div class="gbh" style="left:0px;"></div>
<div class="gbh" style="right:0px;"></div>

<div id="gc-container">
<a id="top"></a>
<div id="skipto">
  <a href="#gc-pagecontent">Skip to page content</a>
  <a href="#gc-toc">Skip to main navigation</a>
</div>

<div id="gc-header">
  <div id="logo"><a href="http://code.google.com">
  
  
     <img src="../images/code_logo.gif" height="40" width="167" alt="Google Code" style="border:0;margin:3px 0 0 0;">
  
  
  </a></div>
  <div id="search">
    <div id="searchForm" class="searchForm">
      <form id="cse" action="http://www.google.com/cse" accept-charset="utf-8" class="gsc-search-box" onsubmit="executeGSearch(document.getElementById('gsearchInput').value); return false;">
      <noscript>
      <input type="hidden" name="cref" value="http://code.google.com/cse/googlecode-context.xml">
      </noscript>
      <div id="gsc-search-box">
        <input id="gsearchInput" type="text" name="q" maxlength="2048" class="gsc-input" autocomplete="off" title="Google Code Search" style="width:345px">
        <div id="cs-searchresults" onclick="event.cancelBubble = true;"></div>
        <input title="Search" id="gsearchButton" class="gsc-search-button" name="sa" value="Search" type="submit">
        <div class="greytext">e.g. "adwords" or "open source"</div>
      </div>
      </form>
    </div> <!-- end searchForm -->
  </div> <!-- end search -->




</div> <!-- end gc-header -->


<div id="codesiteContent">

<a id="gc-topnav-anchor"></a>
<div id="gc-topnav">
  <h1 style="padding:0 0 0 6px;">Google Maps API Family</h1>
  <ul id="articles" class="gc-topnav-tabs">

    <li id="home_link">
      <a href="../index.html" title="Google Maps API Family home page">Home</a>
    </li>
  
    <li id="faq_link">
      <a href="../faq.html" title="Answers to frequently asked questions about Google Maps API Family">FAQ</a>
    </li>
  
    <li id="articles_link">
      <a href="index.html" class="selected" title="Focused articles and tutorials for Google Maps API Family developers">Articles</a>
    </li>
  
    <li>
      <a href="http://googlegeodevelopers.blogspot.com/" title="Official Google Maps API Family blog">Blog</a>
    </li>
  
    <li>
      <a href="../forum/index.html" title="Google Maps API Family developer forum">Forum</a>
    </li>
  
    <li>
      <a href="../terms.html" title="Google Maps API Family terms of service">Terms</a>
    </li>
  

  </ul>
</div> <!-- end gc-topnav -->

    <div class="g-section g-tpl-170">

      <div class="g-unit g-first" id="gc-toc">
        <ul>
  <li><a href="../index.html">Maps API Family</a></li>
  <li><a href="http://code.google.com/apis/kml/documentation/kmlSearch.html">Index Your Maps Content</a></li>
</ul>
      <div class="line"></div>
      <ul>
        <li><h2>Maps Javascript API V3</h2>
         <ul>
           <li><a href="../documentation/javascript/index.html">Home Page</a></li>
           <li><a href="../documentation/javascript/basics.html">Documentation</a></li>
         </ul>
       </li>
      </ul>
      <ul>
        <li><h2>Maps Javascript API V2</h2>
         <p><span style="color:grey">(Deprecated API)</span></p>
         <ul>
           <li><a href="../documentation/javascript/v2/index.html">Home Page</a></li>
           <li><a href="../documentation/javascript/v2/basics.html">Documentation</a></li>
         </ul>
       </li>
      </ul>
  <div class="line"></div>
    <ul>
      <li><h2>Maps API for Flash</h2>
        <ul>
          <li><a href="../documentation/flash/index.html">Home Page</a></li>
          <li><a href="../documentation/flash/intro.html">Documentation</a></li>
        </ul>
      </li>
    </ul>
    <div class="line"></div>
    <ul>
      <li><h2>Maps Data API</h2>
        <p><span style="color:grey">(Deprecated API)</span></p>
        <ul>
          <li><a href="../documentation/mapsdata/index.html">Home Page</a></li>
          <li><a href="../documentation/mapsdata/developers_guide_protocol.html">Documentation</a></li>
        </ul>
      </li>
    </ul>
     <div class="line"></div>
      <ul>
        <li><h2><a href="../documentation/webservices/index.html">Maps Web Services</a></h2>
         <ul>
           <li><a href="../documentation/geocoding/index.html">Geocoding Guide</a></li>
           <li><a href="../documentation/directions/index.html">Directions Guide</a></li>
           <li><a href="../documentation/elevation/index.html">Elevation Guide</a></li>
           <li><a href="../documentation/places/index.html">Places Guide</a></li>
         </ul>
       </li>
      </ul>
      <div class="line"></div>
        <ul>
          <li><h2>Static Maps API</h2>
            <ul>
              <li><a href="../documentation/staticmaps/index.html">Developer Guide</a></li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
        <ul>
          <li><h2>Earth API</h2>
            <ul>
              <li><a href="http://code.google.com/apis/earth">Home Page</a></li>
              <li><a href="http://code.google.com/apis/earth/documentation">Documentation</a></li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
        <ul>
          <li>
            <h2>Local Search API</h2>
            <p><span style="color:grey">(Deprecated API)</span></p>
            <ul>
              <li>
                <a href="../documentation/localsearch/index.html">Home Page</a>
              </li>
              <li>
                <a href="../documentation/localsearch/start.html">Documentation</a>
              </li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
      <div class="promo">
     <p><a href="../documentation/premier/index.html">Google Maps API Premier</a></p><p>Includes enterprise licensing and support</p></div>

        <a class="hidden" href="#gc-topnav-anchor">More Google Maps API Family resource links</a>
      </div>
      
      <div class="g-unit" id="gc-pagecontent">
        <h1 class="page_title">Geospatial Queries with Google App Engine using GeoModel</h1>


<!-- ########## PAGE CONTENT ########## -->
  
<div class=i>
<i>Roman Nurik and Shawn Shen, Google Geo APIs Team</i>
<br>
<i>December 2009</i>

<br><br>

<p class="para">
Two common types of spatial queries used in Maps mash-ups are proximity searches
and bounding box queries. Proximity searches return all results within a certain
distance of a location. Bounding box queries return all results in a bounding box of
four points defined by its four corners. These types of searches are useful in a
wide variety of mash-ups. For instance, a store finder on a website typically allows
the user to show all stores within a certain radius. Or it may want to show all stores
that are in the current map boundaries. While intuitively simple, these searches can be
computationally difficult.</p>

<p class="para">
In this tutorial we will show how to implement these kinds of geospatial searches
using the open source project <a href="http://code.google.com/p/geomodel/"><b><code>GeoModel</code></b></a>
in Python hosted on Google App Engine (GAE).  We will build a demo app
<a href="http://geomodel-demo.appspot.com/"><b><code>PubSchools</code></b></a>, which displays public schools
using bounding box and proximity searches. Developers familiar with Python will
get the most out of this article.
</p>


<p class="para">
The tutorial is organized into the following sections:
</p>
<ul>
<li><a href="#geospatial">Geospatial Queries</a></li>
<li><a href="#appengine">App Engine Datastore</a></li>
<li><a href="#geomodel"><b><code>GeoModel</code></b> and Geocells</a></li>
<li><a href="#pubschool">Inside <b><code>PubSchools</code></b> Demo</a></li>
<li><a href="#wrapup">Putting It Together</a></li>
<li><a href="#wheretogo">Where to Go From Here</a></li>
</ul>
<br>
<a name="geospatial"></a><h3>Geospatial Queries</h3>
<p class="para"> A typical use case of geospatial queries is find the closest 20 locations
that are within a radius of 25 miles to the center of the bounnding box given by <code>(lat_t, lng_t)</code>.
This kind of proximity query requires calculation of relative distances between latitude/longitudes
of pre-defined and pre-loaded geo locations and the target latitude/longitude so that the distance algorithm
can filter by a cut-off distance and order the results by distance. The actual
SQL query looks like this:</p>

<pre class="prettyprint lang-sql">
SELECT id, ( 3959 * acos( cos( radians(lat_t) ) * cos( radians( lat ) ) * cos( radians( lng ) - radians(lng_t) )
       + sin( radians(lat_t) ) * sin( radians( lat ) ) ) ) AS distance
FROM Stores HAVING distance < 25
ORDER BY distance
</pre>
<p class="para"> where <code>Stores</code> is a table that holds the pre-defined and pre-loaded entities
of interest with geo locations such as stores or schools, whose fields <code>lat</code> and <code>lng</code> contain
their respective latitude and longitude (<a href="phpsqlsearch_v3.html">See detail here</a>).
Since relative distances must be calculated based on user input of target location given by <code>(lat_t, lng_t)</code>,
it results in a rather expensive query every time a new set of lat/lng is submitted as input of a new request.</p>

<p class="para">Similarly a bounding box query might look like this in SQL:</p>

<pre class="prettyprint lang-sql">
SELECT *
FROM Stores
WHERE lat > (lat_t - d) AND
    lat < (lat_t + d) AND
    lng > (lng_t - d) AND
    lng < (lng_t + d)
</pre>

<p class="para">where <code>(lat_t, lng_t)</code> represents target coordinate and <code>d</code>
a fixed size for bounding box. While this type of bounding box query can be implemented with proper
indexes in SQL database, it presents a difficulty for the App Engine Datastore, as described in the
next section.</p>

<a name="appengine"></a><h3>App Engine Datastore</h3>
<p class="para">
Google App Engine (GAE) enables you to build web applications on the same scalable systems
that power Google applications. App Engine applications are easy to build, easy to maintain,
and easy to scale as your traffic and data storage needs grow. With App Engine, there are
no servers to maintain: You just upload your application, and it's ready to serve to your users.
</p>


<p class="para">Although Google App Engine has an SQL-like query language, GQL,
its Datastore differs significantly from typical relational database
(see <a href="http://sites.google.com/site/io/under-the-covers-of-the-google-app-engine-datastore">
Under the Cover of the App Engine Datastore</a>). For example, while a simple query like the following is possible:</p>

<pre class="prettyprint lang-sql">
db.GqlQuery("SELECT * FROM Stores ORDER BY &lt;some property&gt; DESC")
</pre>

<p class="para">GQL does not support table 'joins' nor 'having' clause commands. These syntax restrictions make it
difficult to construct a SQL like <code>'having distance < 25'</code>.  This makes it impossible to have
a query by proximity in App Engine.</p>

<p class="para">
Bounding box queries are also not supported in App Engine because there need to be two inequalities on
two independent properties.  App Engine is optimized for performing lookups of single properties and
lookups are implemented via indexes over many servers. When a query needs to compare values of two
independent properties, it would have to spawn two lookups that would have to be executed as two
separate processes on physically separate servers but then merging and sorting returned dataset
over two servers would be problematic at minimum and in general not optimized for high performance.
This makes it impossible to have a scalable solution for this type of queries.</p>

<p class="para">
These limitations on queries prevent us from running either proximity or bounding box queries in App Engine.
To implement these types of searches, we need to use another mechanism by introducing a concept called 
geocell and a <b><code>GeoModel</code></b> class.</p>


<a name="geomodel"></a><h3><b><code>GeoModel</code></b> and Geocells</h3>

<p class="para">
<a href="http://code.google.com/p/geomodel/"><b><code>GeoModel</code></b></a> is an open source project that aims to
provide a generalized solution for performing basic indexing and querying of geospatial data in
Google App Engine.  This implementation introduces a concept called <b><code>geocell</code></b>,
which is a coordinate system that divides the world up into rectangular cells.  The idea is inspired by similar 
concepts in <a href="http://wiki.xkcd.com/geohashing/Main_Page">geohashing</a>. See detailed explanation of geocell
in later section but for now think of it as a rectangular region at various zoom levels.</p>

<p class="para">The <b><code>GeoModel</code></b> class implements a base class that comes with two key interfaces. Developers
can define application-specific entities by extending <b><code>GeoModel</code></b> class and call 
the following two methods without having to do much coding.</p>

<h5>Proximity Search</h5>

<pre class="prettyprint lang-python">
  @staticmethod
  def proximity_fetch(query, center, max_results=10, max_distance=0):
</pre>

<div style="float:left; width:98%">
<div style="float:left; width: 510px; margin:5px; padding:5px;">
<img src="http://geomodel.googlecode.com/svn/trunk/res/prox4.jpg" width="500">
</div>
<div style="float:left; width: 40%; margin:5px; padding:5px;">
<p class="para">The <code>proximity_fetch()</code> method is statically defined at class level
with the following list of parameters:
<ul>
<li><code>query</code>: an object of <code>db.Query</code> type, which can be used to
specify additional filtering and sorting on entities like stores or schools (more on this in
<b><code>PubSchools</code></b> example below)</li>
<li><code>center</code>: the center point of search based on user input</li>
<li><code>max_results</code>: max number of results to return</li>
<li><code>max_distance</code> radius of proximity search</li>
</ul>
</p>

<p class="para">
Proximity query starts with a geocell that contains the <code>center</code> point and queries
that geocell.  It then bubbles its way up to adjacent geocells of next resolutions within
a cut-off distance supplied by the search radius. Here a geocell is basically a rectangular
box labeled by a hexadecimal string, the length of which represents its resolution.
See the sample geocells in the image on the left.
</p>

</div></div>

<h5>Bounding Box Search</h5>
<pre class="prettyprint lang-python">
  @staticmethod
  def bounding_box_fetch(query, bbox, max_results=1000, cost_function=None):
</pre>

<div style="float:left; width:98%">
<div style="float:left; width: 510px; margin:5px; padding:5px;">
<img src="http://geomodel.googlecode.com/svn/trunk/res/bbox2.jpg" width="500">
</div>
<div style="float:left; width: 40%; margin:5px; padding:5px;">
<p class="para">The <code>bounding_box_fetch()</code> method is statically defined at class level
with the following list of parameters:
<ul>
<li><code>query</code>: an object of <code>db.Query</code> type, which can be
used to specify additional filtering</li>
<li><code>bbox</code>: an object of <code>geotypes.Box</code> type representing a bounding box</li>
<li><code>max_results</code>: max number of results to return</li>
</ul>
</p>

<p class="para">
The parameter <code>cost_function</code> is an optional resource calculation that accepts two arguments,
<code>num_cells</code> and <code>resolution</code> of each geocell to search, and returns the
'cost' calculated in number for querying against this number of cells at the given resolution.
</p>

<p class="para">
The bounding box query starts off with a list of geocells inside the input bounding box and then
runs queries against each geocell for relevant entities, merges them, and returns them in a list.
</p>

<p class="para">
As you may see, both proximity and bounding box searches rely on a key concept of
geocell in <b><code>GeoModel</code></b>. The next section will explain how this works.
</p>

</div></div>

<h4>Geocells</h4>

<p class="para">In <b><code>GeoModel</code></b> a geocell is labeled by a hexadecimal string that defines
a two dimensional rectangular region inside the [-90,90] x [-180,180] latitude/longitude
space. Resolution of a geocell is measured by the length of its string label. We start
out with 16 geocells labeled by hexdecimal number with a single digit and subsequently
divide each geocell into 16 more geocells labeled by hexdecimal strings with more digits.</p>

<p class="para">This kind of hierarchical structure of geocells is similar to
<a href="http://en.wikipedia.org/wiki/Geohash">geohash</a> in that any prefix of a geocell
is considered its ancestor, with <code>geocell[:-1]</code> being geocell's immediate
parent cell. As resolution increases, label of a geocell gets longer and the area covered
by the geocell more granular.  For most practical purposes, at very high resolutions (e.g.
precision of 13 digits), geocells can be treated as single points.
</p>

<p class="para">
To calculate the rectangle of a given geocell string, for example '78a', first divide
the [-90,90] x [-180,180] latitude/longitude space evenly into a 4x4 grid as shown in 
Diagram 1 below:</p>

<div style="float:left; width:98%">
<div style="float:left; width:40%; margin:5px; padding:5px;">
<img src="geomodel1.png"><br>
<div style="margin:5px 5px 5px 150px; padding:5px;">
Diagram 1
</div>
</div>
<div style="float:left; width:40%; margin:5px; padding:5px;">
<img src="geomodel2.png"><br>
<div style="margin:5px 5px 5px 150px; padding:5px;">
Diagram 2
</div>
</div>
</div>

<p class="para">
Note that the point (0, 0) is at the intersection of grid cells 3, 6, 9 and c. Each cell
is divided into additional 4x4 grid. For the example of geostring '78a', cell '7' further divides
as shown in Diagram 2 above, and should represent the sub-rectangle from (-45, 90) to (0, 180).</p>

<p class="para">
If we continue to re-divide cell '78' into 4x4 grid of sub-rectangles, we will arrive at
cell '78a'. In general this is the approach to map a geostring to a particular geocell:</p>

<ol>
<li>Start with the initial 4x4 grid that represents the [-90,90] x [-180,180] latitude/longitude space</li>
<li>Divide rectangles into 4x4 grids and sub-rectangles successively</li>
<li>Continue until the entire geocell string has been exhausted and the final sub-rectangle
is the rectangular region for the geocell</li>
</ol>


<a name="geomodel"></a><h3>Inside <b><code>PubSchools</code></b> Demo</h3>


<p class="para">
The <a href="http://geomodel-demo.appspot.com/"><b><code>PubSchools</code></b></a> demo app demonstrates how
to extend <b><code>GeoModel</code></b> and implement geospatial search for public schools. Follow the link
to check out the demo and enter searches (e.g. New York, NY or 94040) to see a list of
public schools. The sample source code is available
<a href="http://code.google.com/p/geomodel/source/browse/#svn/trunk/demos/pubschools">here</a>.
</p>


<h4>Class Model</h4>

<p class="para">
To define your own application-specific class for your own entities, you extend from <b><code>GeoModel</code></b>.
Here is how <b><code>PubSchools</code></b> class entends from Geo Model:
</p>

<pre class="prettyprint lang-python">
class PublicSchool(GeoModel):
  """A location-aware model for public school entities.
  
  """
  school_id = db.StringProperty()
  name = db.StringProperty()
  address = db.StringProperty()
  city = db.StringProperty()
  state = db.StringProperty()
  zip_code = db.IntegerProperty()
  enrollment = db.IntegerProperty()
  phone_number = db.StringProperty()
  locale_code = db.IntegerProperty()
  school_type = db.IntegerProperty()
  school_level = db.IntegerProperty()
  grades_taught = db.ListProperty(int)

</pre>

<p class="para">
The application-specific properties of <b><code>PubSchools</code></b> class such as
<code>address</code>, <code>name</code>, or <code>grades_taught</code> allow additional
query possibilities but the essential functionality of geospatial queries (namely proximity
and bounding box searches) is inherited from <b><code>GeoModel</code></b>.
</p>

<h4>Data Flow</h4>

<p class="para">
Let's say the user enters a query with location info such as 'New York, NY' or
'1600 Pennsylvania Ave NW, Washington, DC.' The <b><code>PubSchools</code></b> demo app will 
geocode the address first. If the query geocodes to something resembling an address or an intersection,
a proximity search is done; otherwise a bounding box search is done on the geocoded area's extents. 
(see <a href="http://code.google.com/p/geomodel/source/browse/trunk/demos/pubschools/static/js/front.js">front.js</a>
for more detail). The demo app will then make an Ajax call using <code>doSearch</code> function as follows.
</p>

<pre class="prettyprint lang-js">
&lt;script type="text/javascript"&gt;
if (proximitySearch) {
  doSearch(updateObject(commonOptions, {
    type: 'proximity',
    center: bounds.getCenter()
  }));
} else {
  doSearch(updateObject(commonOptions, {
    type: 'bounds',
    bounds: bounds
  }));
}
...

function doSearch(options) {
...
  // Perform proximity or bounds search.
  g_currentSearchXHR = $.ajax({
    url: '/s/search',
    type: 'get',
    data: searchParameters,
    dataType: 'json',
...
}
&lt;/script&gt;
</pre>

<p class="para">
The <code>doSearch</code> function sends a request to an endpoint <code>'s/search'</code>
as shown in the code snippet above. More detailed query parameters such as type of search
(bounding box or proximity) and <code>center</code> or <code>bbox</code> boundary are all wrapped inside the
<code>searchParameters</code>.  Requests get processed by <b><code>PubSchools</code></b>'s service handler
<a href="http://code.google.com/p/geomodel/source/browse/trunk/demos/pubschools/handlers/service.py">service.py</a>.
The Python code snippet is given as follows.
</p>

<pre class="prettyprint lang-python">
# Perform proximity or bounds fetch.
if query_type == 'proximity':
   results = PublicSchool.proximity_fetch(base_query, center, max_results=max_results, max_distance=max_distance)
elif query_type == 'bounds':
   results = PublicSchool.bounding_box_fetch(base_query, bounds, max_results=max_results)
</pre>

<p class="para">
Here <b><code>PubSchools</code></b> calls either <code>proximity_fetch()</code> or <code>bounding_box_fetch()</code>
static method from its parent class <b><code>GeoModel</code></b> and returns results in JSON back to a callback function
of the originating Ajax call, which parses out the results and renders them onto Google Map as markers.
</p>

<h4>JSON Data Service</h4>

<p class="para">
Typical JSON data returned by <code>'s/search'</code> service is shown below.
</p>

<pre class="prettyprint lang-json">
{"status": "success", "results": [{"phone_number": "(908) 436-6855", "city": "ELIZABETH", "name": "ELIZABETH HIGH", 
"school_level": 3, "enrollment": 5279, "highest_grade_taught": 12, "lowest_grade_taught": 9, "school_type": 1, 
"locale_code": 21, "state": "NJ", "address": "600 PEARL STREET", "lat": 40.6603361, "lng": -74.2116865, "school_id": 
"340459005478", "zip_code": 7202}]}
</pre>

<p class="para">
Once JSON data are successfully returned to the callback function, the entities inside the data get parsed out and
rendered properly on the map as markers. Detailed info shows in a pop-up info window when a marker is clicked.
See <a href="http://code.google.com/p/geomodel/source/browse/trunk/demos/pubschools/static/js/front.js">front.js</a>
for more detail on <code>success: function(obj)</code> callback function.
</p>

<h4>Batch Load Data</h4>

<p class="para">
Note that data of public schools with location info like latitude and longitude have to be loaded into
App Engine Datastore of <b><code>PubSchools</code></b> demo beforehand in order for
geospatial queries to return results.  This is done via the <code>appcfg.py upload_data</code> utility.
We will skip the detail here but source code and info can be found in the
<a href="http://code.google.com/p/geomodel/source/browse/trunk/demos/pubschools/#pubschools/scripts/batch%3Fstate%3Dclosed">batch</a> folder.
</p>

<a name="wrapup"></a><h3>Putting It Together</h3>

<p class="para">Having covered geospatial queries, App Engine Datastore, <b><code>GeoModel</code></b>,
and internal design of <b><code>PubSchools</code></b> demo, you can put it all together and see the app
in action.  Here's a screenshot of <b><code>PubSchools</code></b> but take a test drive of the live demo at
<a href="http://geomodel-demo.appspot.com/"><b><code>PubSchools</code></b></a> and experiment with various
queries, and toggle between map and list views.<br>
<img src="pubschool.png">
</p>


<p class="para">It is straightforward to set up the maps UI in this demo. As shown below,
we include jquery library, set up a Google Maps API key, and include the <code>front.js</code>.
</p>

<pre class="prettyprint lang-js">
&lt;script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"&gt;&lt;/script&gt;

&lt;script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="http://www.google.com/jsapi?key=&lt;YOUR_API_KEY&gt;"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/lib/jquery.scrollTo-1.4.2-min.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/lib/microtemplate.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript" src="/static/js/front.js"&gt;&lt;/script&gt;
&lt;script type="text/javascript"&gt;
google.load('maps', '2');
google.setOnLoadCallback(init);
&lt;/script&gt;

</pre>

<p class="para">The <code>setOnLoadCallback</code> sets <code>init</code> as callback function
of onLoad complete.  The <code>init</code> function in turn calls <code>initMap</code> and
<code>initUI</code> functions.
</p>

<pre class="prettyprint lang-js">
/**
 * On body/APIs ready callback.
 */
function init() {
  initMap();
  initUI();
}

/**
 * Creates the Google Maps API instance.
 */
function initMap() {
  map = new google.maps.Map2($('#map').get(0));
  map.setCenter(new google.maps.LatLng(39,-96), 4);

  geocoder = new google.maps.ClientGeocoder();
  
  // anything besides default will not work in list view
  map.setUIToDefault();
}

</pre>

<p class="para">
The <code>initMap</code> function loads Google Maps into the <code>'map'</code> div,
centers it around lat/lon <code>(39, -96)</code> in this case, and sets it to default view
while <code>initUI</code> sets up various other UI components and event listeners
(see <a href="http://code.google.com/p/geomodel/source/browse/trunk/demos/pubschools/static/js/front.js">front.js</a>
for more detail) to get ready for user queries.  When user enters query and clicks on
the Search button, an Ajax request is constructed and submitted according to the data flow
outlined above. The JSON results returned from the <code>'/s/search'</code> service endpoint
are rendered on map UI by callback function.
</p>

<a name="wheretogo"></a><h3>Where to Go From Here</h3>

<p class="para">
For other approaches to geospatial queries in Google App Engine, see a geohash-based
<a href="http://code.google.com/p/geodatastore">geodatastore</a> project.
</p>

<p class="para">
Another possible backend solution for spatial queries is the Google Maps Data API.
Recently, it added proximity and bounding box searches as well as attribute search.
See <a href="http://code.google.com/apis/maps/documentation/mapsdata/">Maps Data API</a>
for more info and stay tuned for search capabiity in upcoming revisions.
</p>

</div>

<!-- ########## END PAGE CONTENT ########## -->
  
   
      </div><!-- end gc-pagecontent -->
   </div><!-- end gooey wrapper -->

    </div> <!-- end codesite content -->


<div id="gc-footer" dir="ltr">
  <div class="text">
    
    &copy;2010 Google -
    <a href="http://code.google.com">Code Home</a> -
    <a href="http://code.google.com/terms.html">Terms of Service</a> -
    <a href="http://code.google.com/privacy.html">Privacy Policy</a> -
    <a href="http://code.google.com/more">Site Directory</a>
    <br> <br>
    Google Code offered in:
    <a href="http://code.google.com/intl/en">English</a> -
    <a href="http://code.google.com/intl/es">Español</a> -
    <a href="http://code.google.com/intl/ja">日本語</a> -
    <a href="http://code.google.com/intl/ko">한국어</a> -
    <a href="http://code.google.com/intl/pt-BR">Português</a> -
    <a href="http://code.google.com/intl/ru">Pусский</a> -
    <a href="http://code.google.com/intl/zh-CN">中文(简体)</a> -
    <a href="http://code.google.com/intl/zh-TW">中文(繁體)</a>
  </div>
</div><!-- end gc-footer -->

</div><!-- end gc-container -->

<script type="text/javascript">CODESITE_CSITimer['load'].tick('ats');</script>
<script src="../../../js/codesite_tail.pack.04102009.js" type="text/javascript"></script>




<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(


    ['siteTracker._setAccount', 'UA-18071-1'],
    ['siteTracker._setDomainName', 'code.google.com'],
    ['siteTracker._setCookiePath', window.location.pathname.substring(0,
        window.location.pathname.lastIndexOf('/') + 1)],
    ['siteTracker._trackPageview']
);
(function() {
  var ga = document.createElement('script');

  ga.type = 'text/javascript';
  ga.async = true;
  ga.src = 'http://www.google-analytics.com/ga.js';
  (document.getElementsByTagName('head')[0] ||
   document.getElementsByTagName('body')[0]).appendChild(ga);
 })();
</script>




  </body>
</html>

