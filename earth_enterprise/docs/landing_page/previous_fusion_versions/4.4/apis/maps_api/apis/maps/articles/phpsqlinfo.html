<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">







 
 


 

  
  
  


<html>
  <head>
    <script type="text/javascript" language="JavaScript">
    ORIGINAL_PAGE_PATH = "/apis/maps/articles/phpsqlinfo.html";
    </script>
    
    
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<title>From Info Windows to a Database: Saving User-Added Form Data - Google Maps API Family - Google Code</title>
<script type="text/javascript"><!--
(function(){function a(){this.t={};this.tick=function(c){this.t[c]=(new Date).getTime()};this.tick("start")}var b=new a;window.jstiming={Timer:a,load:b};if(window.external&&window.external.pageT)window.jstiming.pt=window.external.pageT;})();

var _tocPath_ = '/apis/maps/_toc.ezt';
var codesite_token = null;
var logged_in_user_email = null;
//--></script>
<link href="../../../css/codesite.pack.04102009.css" type="text/css" rel="stylesheet">
<script src="../../../js/codesite_head.pack.04102009.js" type="text/javascript"></script>
<script type="text/javascript">CODESITE_CSITimer['load'].tick('bhs');</script>
<link rel="search" type="application/opensearchdescription+xml" title="Google Code" href="http://code.google.com/osd.xml">

<!--[if IE]><link rel="stylesheet" type="text/css" href="../../../css/iehacks.css"><![endif]-->

    <link href="../../../css/semantic_headers.css" rel="stylesheet" type="text/css" />
  </head>

  <body class="gc-documentation">

    
    
    <div id="gb">
 <span>
  
    <a id="lang-dropdown" href="http://code.google.com" onclick="return false;"><span style="text-decoration:underline">English</span> <span style="font-size:.75em;">&#9660;</span></a>
  
 </span>
</div>

<div class="gbh" style="left:0px;"></div>
<div class="gbh" style="right:0px;"></div>

<div id="gc-container">
<a id="top"></a>
<div id="skipto">
  <a href="#gc-pagecontent">Skip to page content</a>
  <a href="#gc-toc">Skip to main navigation</a>
</div>

<div id="gc-header">
  <div id="logo"><a href="http://code.google.com">
  
  
     <img src="../images/code_logo.gif" height="40" width="167" alt="Google Code" style="border:0;margin:3px 0 0 0;">
  
  
  </a></div>
  <div id="search">
    <div id="searchForm" class="searchForm">
      <form id="cse" action="http://www.google.com/cse" accept-charset="utf-8" class="gsc-search-box" onsubmit="executeGSearch(document.getElementById('gsearchInput').value); return false;">
      <noscript>
      <input type="hidden" name="cref" value="http://code.google.com/cse/googlecode-context.xml">
      </noscript>
      <div id="gsc-search-box">
        <input id="gsearchInput" type="text" name="q" maxlength="2048" class="gsc-input" autocomplete="off" title="Google Code Search" style="width:345px">
        <div id="cs-searchresults" onclick="event.cancelBubble = true;"></div>
        <input title="Search" id="gsearchButton" class="gsc-search-button" name="sa" value="Search" type="submit">
        <div class="greytext">e.g. "adwords" or "open source"</div>
      </div>
      </form>
    </div> <!-- end searchForm -->
  </div> <!-- end search -->




</div> <!-- end gc-header -->


<div id="codesiteContent">

<a id="gc-topnav-anchor"></a>
<div id="gc-topnav">
  <h1 style="padding:0 0 0 6px;">Google Maps API Family</h1>
  <ul id="articles" class="gc-topnav-tabs">

    <li id="home_link">
      <a href="../index.html" title="Google Maps API Family home page">Home</a>
    </li>
  
    <li id="faq_link">
      <a href="../faq.html" title="Answers to frequently asked questions about Google Maps API Family">FAQ</a>
    </li>
  
    <li id="articles_link">
      <a href="index.html" class="selected" title="Focused articles and tutorials for Google Maps API Family developers">Articles</a>
    </li>
  
    <li>
      <a href="http://googlegeodevelopers.blogspot.com/" title="Official Google Maps API Family blog">Blog</a>
    </li>
  
    <li>
      <a href="../forum/index.html" title="Google Maps API Family developer forum">Forum</a>
    </li>
  
    <li>
      <a href="../terms.html" title="Google Maps API Family terms of service">Terms</a>
    </li>
  

  </ul>
</div> <!-- end gc-topnav -->

    <div class="g-section g-tpl-170">

      <div class="g-unit g-first" id="gc-toc">
        <ul>
  <li><a href="../index.html">Maps API Family</a></li>
  <li><a href="http://code.google.com/apis/kml/documentation/kmlSearch.html">Index Your Maps Content</a></li>
</ul>
      <div class="line"></div>
      <ul>
        <li><h2>Maps Javascript API V3</h2>
         <ul>
           <li><a href="../documentation/javascript/index.html">Home Page</a></li>
           <li><a href="../documentation/javascript/basics.html">Documentation</a></li>
         </ul>
       </li>
      </ul>
      <ul>
        <li><h2>Maps Javascript API V2</h2>
         <p><span style="color:grey">(Deprecated API)</span></p>
         <ul>
           <li><a href="../documentation/javascript/v2/index.html">Home Page</a></li>
           <li><a href="../documentation/javascript/v2/basics.html">Documentation</a></li>
         </ul>
       </li>
      </ul>
  <div class="line"></div>
    <ul>
      <li><h2>Maps API for Flash</h2>
        <ul>
          <li><a href="../documentation/flash/index.html">Home Page</a></li>
          <li><a href="../documentation/flash/intro.html">Documentation</a></li>
        </ul>
      </li>
    </ul>
    <div class="line"></div>
    <ul>
      <li><h2>Maps Data API</h2>
        <p><span style="color:grey">(Deprecated API)</span></p>
        <ul>
          <li><a href="../documentation/mapsdata/index.html">Home Page</a></li>
          <li><a href="../documentation/mapsdata/developers_guide_protocol.html">Documentation</a></li>
        </ul>
      </li>
    </ul>
     <div class="line"></div>
      <ul>
        <li><h2><a href="../documentation/webservices/index.html">Maps Web Services</a></h2>
         <ul>
           <li><a href="../documentation/geocoding/index.html">Geocoding Guide</a></li>
           <li><a href="../documentation/directions/index.html">Directions Guide</a></li>
           <li><a href="../documentation/elevation/index.html">Elevation Guide</a></li>
           <li><a href="../documentation/places/index.html">Places Guide</a></li>
         </ul>
       </li>
      </ul>
      <div class="line"></div>
        <ul>
          <li><h2>Static Maps API</h2>
            <ul>
              <li><a href="../documentation/staticmaps/index.html">Developer Guide</a></li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
        <ul>
          <li><h2>Earth API</h2>
            <ul>
              <li><a href="http://code.google.com/apis/earth">Home Page</a></li>
              <li><a href="http://code.google.com/apis/earth/documentation">Documentation</a></li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
        <ul>
          <li>
            <h2>Local Search API</h2>
            <p><span style="color:grey">(Deprecated API)</span></p>
            <ul>
              <li>
                <a href="../documentation/localsearch/index.html">Home Page</a>
              </li>
              <li>
                <a href="../documentation/localsearch/start.html">Documentation</a>
              </li>
            </ul>
          </li>
        </ul>
      <div class="line"></div>
      <div class="promo">
     <p><a href="../documentation/premier/index.html">Google Maps API Premier</a></p><p>Includes enterprise licensing and support</p></div>

        <a class="hidden" href="#gc-topnav-anchor">More Google Maps API Family resource links</a>
      </div>
      
      <div class="g-unit" id="gc-pagecontent">
        <h1 class="page_title">From Info Windows to a Database: Saving User-Added Form Data</h1>


<!-- ########## PAGE CONTENT ########## -->

<div class=i>
<em>Pamela Fox, Google Maps API Team
<br>September 2007</em>
<p class="para" style="background-color:#eeeeee; padding:5px">This is the 
third article in our series on using PHP/MySQL with Google Geo APIs. If you're 
a PHP/MySQL developer, you may also be interested in our articles on 
<a href="phpsqlajax.html">loading markers from a database
</a> and <a href="http://code.google.com/apis/kml/articles/phpmysqlkml.html">
creating KML from a database</a>.

</p>
<h3>Objective</h3>
<p class="para">
Many developers use the Google Maps API to create mashups that enable users to add and annotate geographically located information.
The most intuitive user interface for accomplishing that goal is to have the user first create a marker or poly, pop up a window with a form, then let the user fill out the form and press a 'save' button to close the info window. This is the method used, for instance, by Google's My Maps service.
This tutorial will explain the concepts behind the HTML and JavaScript that make up the info-window editing user interface, as well as the PHP code that can be used to add the saved info window data into a MySQL database. Developers following this tutorial should have some HTML/JavaScript/Google Maps API experience, as well as PHP/MySQL knowledge.
</p>
<p class="para">
This article is broken up into the following steps:
</p>
<ul>
<li><a href="#CreatingTable">Creating the table</a></li>
<li><a href="#AddingRow">Adding row data with PHP</a></li>
<li><a href="#CreatingMap">Creating the map & UI</a></li>

</ul>
<br/>
<a name="CreatingTable"></a><h3>Creating the table</h3>
<p class="para">
When you create the MySQL table, you want to pay particular attention to the lat and lng attributes. With the current zoom capabilities of Google Maps, you should only need 6 digits of precision after the decimal. To keep the storage space required for our table at a minimum, you can specify that the lat and lng attributes are floats of size (10,6). That will let the fields store 6 digits after the decimal, plus up to 4 digits before the decimal, e.g. -123.456789 degrees. Your table should also have an id attribute to serve as the primary key, and a type attribute to distinguish between restaurants and bars, as we'll let users select one of those options from a drop-down select in the form.</p>
<p class="para"> If you prefer interacting with your database through the
phpMyAdmin interface, here's a screenshot of the table creation.
</p>
<p class="para">
<img src="http://www.google.com/help/hc/images/phpsqlinfo_createtable.jpg" style="border: 1px solid grey; margin-left: 2em;" width="600">
</p>
<p class="para"> If you don't have access to phpMyAdmin or prefer using SQL
commands instead, here's the SQL statement that creates the table. <a href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlinfo/phpsqlinfo_createtable.sql" target="_blank">phpsqlinfo_createtable.sql</a>:</p>

<pre class="code">CREATE TABLE `markers` (
  `id` INT NOT NULL AUTO_INCREMENT PRIMARY KEY ,
  `name` VARCHAR( 60 ) NOT NULL ,
  `address` VARCHAR( 80 ) NOT NULL ,
  `lat` FLOAT( 10, 6 ) NOT NULL ,
  `lng` FLOAT( 10, 6 ) NOT NULL ,
  `type` VARCHAR( 30 ) NOT NULL
) ENGINE = MYISAM ;
</pre>
<br>
<a name="AddingRow"></a><h3>Adding row data with PHP</h3>
<p class="para">
At this point, you should have an empty table named <code>markers</code>. You now need to write some PHP statements that can add a row to the table with data passed into the URL. The functions used here should work in both PHP 4 and PHP 5. If you've never written PHP to connect to a MySQL database, you should visit <a href="http://www.php.net">php.net</a> and read up on <code>mysql_connect</code>, <code>mysql_select_db</code>, <code>my_sql_query</code>, and <code>mysql_error</code>.

</p>
<p class="para"> First, you should put your database connection information in a
separate file. This is generally a good idea whenever you're using PHP
to access a database, as it keeps your confidential information in a
file that you won't be tempted to share. In the Maps API forum, we've
occasionally had people accidentally publish their database connection
information when they were just trying to debug their XML-outputting
code. The file should look like this, but with your own database
information filled in (<a href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlinfo/phpsqlinfo_dbinfo.php" target="_blank">phpsqlinfo_dbinfo.php</a>): </p>
<pre class="code">&lt;?
$username="username";
$password="password";
$database="username-databaseName";
?&gt;
</pre>
<p class="para">
Now, you can write the code that will do the fun stuff &mdash; inserting the row. In the PHP, first retrieve the user data passed in through the URL, then connect to your database and execute an <code>"INSERT INTO"</code> query on your table, passing in the user data.
If there's an error along the way, output a message to the screen to help you debug what's going on. To test that this PHP script works correctly, visit the URL in the browser and append the necessary parameters, e.g.:
</p>

<a href="http://yourdomain.com/phpsqlinfo_addrow.php?name=Best%20Bar%20Ever&address=123%20Main%20St&lat=-37.12345&lng=122.12345&type=bar">
http://yourdomain.com/phpsqlinfo_addrow.php?name=Best%20Bar%20Ever&address=123%20Main%20St&lat=-37.12345&lng=122.12345&type=bar
</a>
<p class="para">
If no error message is output to the screen, then the PHP worked. Just make sure to delete later the rows you added while debugging.
</p>
<p class="para">
The PHP file that does all that is shown below (<a href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlinfo/phpsqlinfo_addrow.php" target="_blank">phpsqlinfo_addrow.php</a>):
</p>
<pre class="code">
&lt;?php
require("phpsqlinfo_dbinfo.php");

// Gets data from URL parameters
$name = $_GET['name'];
$address = $_GET['address'];
$lat = $_GET['lat'];
$lng = $_GET['lng'];
$type = $_GET['type'];

// Opens a connection to a MySQL server
$connection=mysql_connect ("localhost", $username, $password);
if (!$connection) {
  die('Not connected : ' . mysql_error());
}

// Set the active MySQL database
$db_selected = mysql_select_db($database, $connection);
if (!$db_selected) {
  die ('Can\'t use db : ' . mysql_error());
}

// Insert new row with user data
$query = sprintf("INSERT INTO markers " .
         " (id, name, address, lat, lng, type ) " .
         " VALUES (NULL, '%s', '%s', '%s', '%s', '%s');",
         mysql_real_escape_string($name),
         mysql_real_escape_string($address),
         mysql_real_escape_string($lat),
         mysql_real_escape_string($lng),
         mysql_real_escape_string($type));

$result = mysql_query($query);

if (!$result) {
  die('Invalid query: ' . mysql_error());
}

?&gt;

</pre>
<a name="CreatingMap"></a><h3>Creating the map & UI</h3>
<p class="para">
Now that the backend functionality is setup, it's time to move onto creating the map and user interface functionality. If you have never created a Google Map, please try some of the basic examples in the documentation to make sure you understand the basics of creating a Google Map.
</p>
<h4>Creating the Marker + Info Window</h4>
<p class="para">
After creating the map and centering it, you can assign a click listener to the map. In the callback function to the listener, create a marker at the coordinate that was clicked and set the draggable property to <code>"true"</code> in the <code>GMarkerOptions</code> object you send in to the constructor. Then, assign a click listener to the marker that pops open an info window over the marker. The info window has the HTML for a form with several text fields, a drop down, and a save button. Each form input has an ID, and the button has an onclick listener to call the <code>saveData</code> function, described below.

</p>
<h4>Saving the Data</h4>
<p class="para">
In the <code>saveData</code> function that's called by the info window button, you do the following: <br/>
<ul>
 <li>Save the value of the marker coordinates and all the form elements (escaping when needed, for URL-friendliness).
 <li>Construct a URL by concatenating the name of the PHP file with the parameters and their values.
 <li>Pass the URL as the first parameter of <code>GDownloadUrl</code>, an API-provided function which wraps the XMLHTTPRequest object that lets you retrieve files (commonly in XML format) via JavaScript. The <code>GDownloadUrl</code> callback function will provide you with the content of the URL and the status code.
 <li>Check that the returned status code is 200. This means that the file was retrieved successfully and we can continue processing.
 <li>Check the length of the data string returned &mdash; an empty data file signifies no error strings were outputted. If the length is near zero, you can close the info window and output a success message.

</ul>
</p>
<p class="para">
The HTML file that does this is shown below (<a href="http://gmaps-samples.googlecode.com/svn/trunk/articles-phpsqlinfo/phpsqlinfo_add.html" target="_blank">phpsqlinfo_add.html</a>):
</p>
<pre class="code">
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml"&gt;
  &lt;head&gt;

    &lt;meta http-equiv="content-type" content="text/html; charset=utf-8"/&gt;

    &lt;title&gt;Google Maps JavaScript API Example: Simple Map&lt;/title&gt;
    &lt;script src="http://maps.google.com/maps?file=api&v=2.x&key=ABQIAAAAjU0EJWnWPMv7oQ-jjS7dYxTPZYElJSBeBUeMSX5xXgq6lLjHthSAk20WnZ_iuuzhMt60X_ukms-AUg"
            type="text/javascript"&gt;&lt;/script&gt;
    &lt;script type="text/javascript"&gt;

    var marker;

    function initialize() {
      if (GBrowserIsCompatible()) {
        var map = new GMap2(document.getElementById("map_canvas"));
        map.setCenter(new GLatLng(37.4419, -122.1419), 13);

        GEvent.addListener(map, "click", function(overlay, latlng) {
          if (latlng) {
            marker = new GMarker(latlng, {draggable:true});
            GEvent.addListener(marker, "click", function() {
              var html = "&lt;table&gt;" +
                         "&lt;tr&gt;&lt;td&gt;Name:&lt;/td&gt; &lt;td&gt;&lt;input type='text' id='name'/&gt; &lt;/td&gt; &lt;/tr&gt;" +
                         "&lt;tr&gt;&lt;td&gt;Address:&lt;/td&gt; &lt;td&gt;&lt;input type='text' id='address'/&gt;&lt;/td&gt; &lt;/tr&gt;" +
                         "&lt;tr&gt;&lt;td&gt;Type:&lt;/td&gt; &lt;td&gt;&lt;select id='type'&gt;" +
                         "&lt;option value='bar' SELECTED&gt;bar&lt;/option&gt;" +
                         "&lt;option value='restaurant'&gt;restaurant&lt;/option&gt;" +
                         "&lt;/select&gt; &lt;/td&gt;&lt;/tr&gt;" +
                         "&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;input type='button' value='Save & Close' onclick='saveData()'/&gt;&lt;/td&gt;&lt;/tr&gt;";

              marker.openInfoWindow(html);
            });
            map.addOverlay(marker);
          }
        });

      }
    }

    function saveData() {
      var name = escape(document.getElementById("name").value);
      var address = escape(document.getElementById("address").value);
      var type = document.getElementById("type").value;
      var latlng = marker.getLatLng();
      var lat = latlng.lat();
      var lng = latlng.lng();

      var url = "phpsqlinfo_addrow.php?name=" + name + "&address=" + address +
                "&type=" + type + "&lat=" + lat + "&lng=" + lng;
      GDownloadUrl(url, function(data, responseCode) {
        if (responseCode == 200 && data.length &lt;= 1) {
          marker.closeInfoWindow();
          document.getElementById("message").innerHTML = "Location added.";
        }
      });
    }
    &lt;/script&gt;

  &lt;/head&gt;

  &lt;body onload="initialize()" onunload="GUnload()"&gt;
    &lt;div id="map_canvas" style="width: 500px; height: 300px"&gt;&lt;/div&gt;
    &lt;div id="message"&gt;&lt;/div&gt;
  &lt;/body&gt;

&lt;/html&gt;
</pre>
  <p class="para">The map should look like this, when the info window is opened:</p>
  <img src="http://www.google.com/help/hc/images/phpsqlinfo_map.jpg" style="border: 1px solid grey; margin-left: 2em;" alt="Screenshot of map"/>
<a name="WhereToGo"></a><h3>Where to go from here</h3>
Now that you have a basic running example of adding user-annotated data from a Google Map into your database, there are many more fun features you can add. Some ideas:
<ul>
 <li>Let users create polygons, and annotate them with info: Check out the <a href="ezdigitizer.html" target="_blank">E-Z digitizer tutorial</a> for the polygon creation, add a poly click listener with our info window, and modify the <code>saveData</code> function to retrieve the points of the poly with the <code>getNumVertices</code> and <code>getVertex</code> function. You'll probably want to create a separate table in your database just for storing the poly points data.</li>

 <li>Let users 'rate' each location: Modify a <a href="http://www.google.com/search?q=star+rating+javascript&ie=utf-8&oe=utf-8&aq=t&rls=org.mozilla:en-US:official&client=firefox-a" target="_blank">star rating system</a>, add it to your info window, and save the rating to the table.</li>
 <li>Output all of the user-added data on one map: Check out our <a href="phpsqlajax.html">PHP/MySQL -&gt; Google Maps tutorial</a>. It uses the exact same table structure, so you'll be able to skip right down to the "Creating the Map" section.
 </li>
</ul>
If you have any issues or questions about this tutorial, please post them in the <a href="http://groups.google.com/group/Google-Maps-API">Maps API forum</a>. Happy mashing!
</p>

</div>

<!-- ########## END PAGE CONTENT ########## -->
  
   
      </div><!-- end gc-pagecontent -->
   </div><!-- end gooey wrapper -->

    </div> <!-- end codesite content -->


<div id="gc-footer" dir="ltr">
  <div class="text">
    
    &copy;2010 Google -
    <a href="http://code.google.com">Code Home</a> -
    <a href="http://code.google.com/terms.html">Terms of Service</a> -
    <a href="http://code.google.com/privacy.html">Privacy Policy</a> -
    <a href="http://code.google.com/more">Site Directory</a>
    <br> <br>
    Google Code offered in:
    <a href="http://code.google.com/intl/en">English</a> -
    <a href="http://code.google.com/intl/es">Español</a> -
    <a href="http://code.google.com/intl/ja">日本語</a> -
    <a href="http://code.google.com/intl/ko">한국어</a> -
    <a href="http://code.google.com/intl/pt-BR">Português</a> -
    <a href="http://code.google.com/intl/ru">Pусский</a> -
    <a href="http://code.google.com/intl/zh-CN">中文(简体)</a> -
    <a href="http://code.google.com/intl/zh-TW">中文(繁體)</a>
  </div>
</div><!-- end gc-footer -->

</div><!-- end gc-container -->

<script type="text/javascript">CODESITE_CSITimer['load'].tick('ats');</script>
<script src="../../../js/codesite_tail.pack.04102009.js" type="text/javascript"></script>




<script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(


    ['siteTracker._setAccount', 'UA-18071-1'],
    ['siteTracker._setDomainName', 'code.google.com'],
    ['siteTracker._setCookiePath', window.location.pathname.substring(0,
        window.location.pathname.lastIndexOf('/') + 1)],
    ['siteTracker._trackPageview']
);
(function() {
  var ga = document.createElement('script');

  ga.type = 'text/javascript';
  ga.async = true;
  ga.src = 'http://www.google-analytics.com/ga.js';
  (document.getElementsByTagName('head')[0] ||
   document.getElementsByTagName('body')[0]).appendChild(ga);
 })();
</script>




  </body>
</html>

